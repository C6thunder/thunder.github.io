<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>笔记详情 - 个人笔记网站</title>
    <link rel="stylesheet" href="style.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .note-content-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }

        .note-content {
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 60px 80px;
            margin: 30px 0;
            border: 1px solid var(--glass-border);
            box-shadow: 0 8px 32px var(--shadow);
            max-width: 1200px;
            width: 100%;
            line-height: 1.8;
        }

        .note-title {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 20px;
            background: var(--text-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .note-meta {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid var(--glass-border);
            flex-wrap: wrap;
        }

        .note-date {
            display: flex;
            align-items: center;
            gap: 8px;
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .note-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 20px;
        }

        .note-body {
            line-height: 1.8;
            font-size: 1.1rem;
            color: var(--text-primary);
        }

        .note-body h2 {
            font-size: 1.8rem;
            margin: 30px 0 15px;
            color: var(--primary);
        }

        .note-body h3 {
            font-size: 1.4rem;
            margin: 25px 0 10px;
            color: var(--primary);
        }

        .note-body h4 {
            font-size: 1.3rem;
            margin: 20px 0 8px;
            color: var(--primary);
        }

        .note-body blockquote {
            background: rgba(var(--primary-rgb), 0.1);
            border-left: 4px solid var(--primary);
            padding: 15px 20px;
            margin: 20px 0;
            font-style: italic;
            color: var(--text-secondary);
        }

        .note-body pre {
            background: rgba(0, 0, 0, 0.3);
            padding: 20px;
            border-radius: 10px;
            overflow-x: auto;
            margin: 20px 0;
        }

        .note-body code {
            font-family: 'Courier New', monospace;
            background: rgba(0, 0, 0, 0.2);
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.9em;
        }

        .note-body ul {
            margin: 15px 0;
            padding-left: 30px;
        }

        .note-body li {
            margin: 8px 0;
        }

        .note-body hr {
            border: none;
            border-top: 2px solid var(--glass-border);
            margin: 30px 0;
        }

        .note-body p {
            margin: 15px 0;
        }

        .note-body code {
            background: var(--glass-bg);
            padding: 2px 8px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
        }

        .note-body pre {
            background: var(--glass-bg);
            padding: 20px;
            border-radius: 10px;
            overflow-x: auto;
            margin: 20px 0;
            border: 1px solid var(--glass-border);
        }

        .note-body pre code {
            background: none;
            padding: 0;
        }

        .note-body ul,
        .note-body ol {
            margin: 15px 0 15px 30px;
        }

        .note-body li {
            margin: 8px 0;
        }

        .note-body blockquote {
            border-left: 4px solid var(--primary);
            padding-left: 20px;
            margin: 20px 0;
            color: var(--text-secondary);
            font-style: italic;
        }

        /* 评论区域 */
        .comments-section {
            margin-top: 50px;
        }

        .comments-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
        }

        .comments-title {
            font-size: 1.5rem;
            font-weight: 600;
        }

        .comment-count {
            background: var(--primary);
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.9rem;
        }

        .comment-form {
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
            border: 1px solid var(--glass-border);
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: var(--text-primary);
            font-weight: 500;
        }

        .form-group input,
        .form-group textarea {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid var(--glass-border);
            border-radius: 10px;
            background: var(--glass-bg);
            color: var(--text-primary);
            font-family: inherit;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .form-group input:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .form-group textarea {
            resize: vertical;
            min-height: 120px;
        }

        .submit-btn {
            background: linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%);
            color: white;
            border: none;
            padding: 14px 32px;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .submit-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 20px rgba(102, 126, 234, 0.4);
        }

        .submit-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .comment-list {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .comment-item {
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            border-radius: 15px;
            padding: 20px;
            border: 1px solid var(--glass-border);
        }

        .comment-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px;
        }

        .comment-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
        }

        .comment-author {
            font-weight: 600;
            color: var(--text-primary);
        }

        .comment-date {
            color: var(--text-secondary);
            font-size: 0.85rem;
        }

        .comment-content {
            color: var(--text-primary);
            line-height: 1.6;
            white-space: pre-wrap;
        }

        .empty-comments {
            text-align: center;
            padding: 40px;
            color: var(--text-secondary);
        }

        .empty-comments i {
            font-size: 3rem;
            margin-bottom: 15px;
            opacity: 0.5;
        }

        @media (max-width: 768px) {
            .note-content {
                padding: 20px;
            }

            .note-title {
                font-size: 1.8rem;
            }

            .note-meta {
                flex-direction: column;
                align-items: flex-start;
                gap: 12px;
            }
        }
    </style>
</head>

<body data-theme="violet">
    <div class="background">
        <div class="gradient-orb orb-1"></div>
        <div class="gradient-orb orb-2"></div>
        <div class="gradient-orb orb-3"></div>
        <div class="gradient-orb orb-4"></div>
        <div class="gradient-orb orb-5"></div>
    </div>
    <div class="particles" id="particles"></div>

    <!-- 主题切换器 -->
    <div class="theme-switcher">
        <button class="theme-toggle-btn" id="themeToggle" title="切换主题">
            <i class="fas fa-palette"></i>
        </button>
        <div class="theme-panel" id="themePanel">
            <h3><i class="fas fa-magic"></i> 选择主题</h3>
            <div class="theme-options">
                <div class="theme-option" data-theme="violet"
                    style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);" title="紫罗兰梦境">
                    <div class="theme-label">紫罗兰</div>
                </div>
                <div class="theme-option" data-theme="cyber"
                    style="background: linear-gradient(135deg, #00f0ff 0%, #ff00ff 100%);" title="霓虹赛博">
                    <div class="theme-label">赛博</div>
                </div>
                <div class="theme-option" data-theme="minimal"
                    style="background: linear-gradient(135deg, #ffffff 0%, #888888 100%);" title="极简黑白">
                    <div class="theme-label">极简</div>
                </div>
                <div class="theme-option" data-theme="sunset"
                    style="background: linear-gradient(135deg, #ff6b6b 0%, #feca57 100%);" title="日落暖阳">
                    <div class="theme-label">暖阳</div>
                </div>
                <div class="theme-option" data-theme="ocean"
                    style="background: linear-gradient(135deg, #00bfff 0%, #1e90ff 100%);" title="深海幽蓝">
                    <div class="theme-label">深海</div>
                </div>
            </div>
        </div>
    </div>

    <div class="container">
        <header class="header">
            <div class="header-nav">
                <a href="index.html" class="back-btn">
                    <i class="fas fa-arrow-left"></i> 首页
                </a>
                <a href="notes.html" class="back-btn">
                    <i class="fas fa-book"></i> 所有笔记
                </a>
            </div>
        </header>

        <div class="content-section">
            <div id="noteContainer">
                <div class="loading">加载中...</div>
            </div>

            <!-- 评论区域 -->
            <div class="comments-section" id="commentsSection" style="display: none;">
                <div class="comments-header">
                    <h2 class="comments-title">
                        <i class="fas fa-comments"></i> 评论区
                    </h2>
                    <span class="comment-count" id="commentCount">0</span>
                </div>

                <div class="comment-form">
                    <h3 style="margin-bottom: 15px;">
                        <i class="fas fa-edit"></i> 发表评论
                    </h3>
                    <form id="commentForm">
                        <div class="form-group">
                            <label for="commentAuthor">昵称（可选）</label>
                            <input type="text" id="commentAuthor" placeholder="请输入您的昵称（或留空）">
                            <small
                                style="color: var(--text-secondary); font-size: 0.85rem; margin-top: 5px; display: block;">
                                <i class="fas fa-info-circle"></i> 可匿名评论，不填写昵称将以"匿名用户"显示
                            </small>
                        </div>
                        <div class="form-group">
                            <label for="commentContent">评论内容（必填）</label>
                            <textarea id="commentContent" required placeholder="写下您的评论..."></textarea>
                        </div>
                        <button type="submit" class="submit-btn">
                            <i class="fas fa-paper-plane"></i> 发表评论
                        </button>
                    </form>
                </div>

                <div class="comment-list" id="commentList">
                    <div class="empty-comments">
                        <i class="fas fa-comments"></i>
                        <p>暂无评论，来发表第一个评论吧！</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="script.js"></script>
    <script src="github-api.js"></script>

    <script>
        window.setupEncryptedToken({
            token: "lNR9YHMTLt0NT4G74I8p3qDY+Qxf7XJAf1ZupELPZpORCw+VQyk7wQ4JIN467U1t3bpXCwa/PKW+H89k7sUFL2mtyU+74rof+MkdLfBTWLFRl4ABnitXNeG4fNo0PToItXVIGvotqhIEJbdWnw==",
            iv: "qNWMHi6UqGFcdWee",
            salt: "P3RiVIlxU1RLiUV8YbefVQ==",
            iterations: 100000,
            password: "lei20060113"  // 解密密码
        });
    </script>

    <script>
        // 全局变量
        let currentNote = null;
        let comments = [];

        // 背景粒子效果
        function createBackgroundParticles() {
            const particlesContainer = document.getElementById('particles');
            const particleCount = 30;

            for (let i = 0; i < particleCount; i++) {
                const particle = document.createElement('div');
                particle.className = 'particle bg-particle';
                particle.style.left = Math.random() * 100 + '%';
                particle.style.animationDelay = Math.random() * 15 + 's';
                particle.style.animationDuration = (20 + Math.random() * 10) + 's';
                particle.style.opacity = '0.2';
                particlesContainer.appendChild(particle);
            }
        }

        // 鼠标跟随粒子效果
        function initMouseFollowParticles() {
            const canvas = document.createElement('canvas');
            canvas.id = 'mouse-canvas';
            document.body.appendChild(canvas);

            const ctx = canvas.getContext('2d');
            const particles = [];
            const mouse = { x: 0, y: 0 };

            function resize() {
                canvas.width = window.innerWidth;
                canvas.height = window.innerHeight;
            }
            resize();
            window.addEventListener('resize', resize);

            document.addEventListener('mousemove', (e) => {
                mouse.x = e.clientX;
                mouse.y = e.clientY;

                for (let i = 0; i < 5; i++) {
                    particles.push({
                        x: mouse.x,
                        y: mouse.y,
                        vx: (Math.random() - 0.5) * 2,
                        vy: (Math.random() - 0.5) * 2,
                        life: 1,
                        size: Math.random() * 3 + 2
                    });
                }
            });

            function animate() {
                ctx.clearRect(0, 0, canvas.width, canvas.height);

                particles.forEach((particle, index) => {
                    particle.x += particle.vx;
                    particle.y += particle.vy;
                    particle.life -= 0.02;

                    if (particle.life <= 0) {
                        particles.splice(index, 1);
                        return;
                    }

                    const alpha = particle.life;
                    const gradient = ctx.createRadialGradient(
                        particle.x, particle.y, 0,
                        particle.x, particle.y, particle.size * 2
                    );
                    gradient.addColorStop(0, `rgba(102, 126, 234, ${alpha})`);
                    gradient.addColorStop(0.5, `rgba(240, 147, 251, ${alpha * 0.5})`);
                    gradient.addColorStop(1, 'rgba(0, 0, 0, 0)');

                    ctx.fillStyle = gradient;
                    ctx.beginPath();
                    ctx.arc(particle.x, particle.y, particle.size, 0, Math.PI * 2);
                    ctx.fill();
                });

                requestAnimationFrame(animate);
            }

            animate();
        }

        // 加载笔记
        async function loadNote() {
            const urlParams = new URLSearchParams(window.location.search);
            const noteId = urlParams.get('id');

            if (!noteId) {
                document.getElementById('noteContainer').innerHTML = '<div class="error-state"><i class="fas fa-exclamation-circle"></i><p>笔记ID不存在</p></div>';
                return;
            }

            try {
                const response = await fetch('./notes/notes.json');
                const data = await response.json();
                currentNote = data.notes.find(note => note.id === noteId);

                if (!currentNote) {
                    document.getElementById('noteContainer').innerHTML = '<div class="error-state"><i class="fas fa-exclamation-circle"></i><p>笔记不存在</p></div>';
                    return;
                }

                renderNote();
                loadComments();

            } catch (error) {
                console.error('加载笔记失败:', error);
                document.getElementById('noteContainer').innerHTML = '<div class="error-state"><i class="fas fa-exclamation-circle"></i><p>加载失败，请刷新页面重试</p></div>';
            }
        }

        // 渲染笔记
        function renderNote() {
            const noteContainer = document.getElementById('noteContainer');
            const hasKey = currentNote.authorKey;

            noteContainer.innerHTML = `
                <div class="note-content">
                    <div class="note-title-section">
                        <h1 class="note-title">${currentNote.title}</h1>
                        <div class="note-actions">
                            ${hasKey
                                ? '<button class="action-btn edit-btn" onclick="showKeyForm()"><i class="fas fa-key"></i> 输入密钥</button>'
                                : '<button class="action-btn edit-btn" onclick="showEditForm()"><i class="fas fa-edit"></i> 修改笔记</button>'
                            }
                        </div>
                    </div>
                    <div class="note-meta">
                        <div class="note-date">
                            <i class="fas fa-calendar"></i>
                            ${currentNote.date}
                        </div>
                    </div>
                    <div class="note-tags">
                        ${currentNote.tags.map(tag => `<span class="tag">${tag}</span>`).join('')}
                    </div>
                    <div class="note-body">
                        ${formatContent(currentNote.content)}
                    </div>
                </div>

                ${!hasKey ? `
                <div class="edit-form" id="editForm" style="display: none;">
                    <h3><i class="fas fa-edit"></i> 修改笔记</h3>
                    <div class="form-group">
                        <label>标题</label>
                        <input type="text" id="editTitle" value="${currentNote.title}">
                    </div>
                    <div class="form-group">
                        <label>标签（用逗号分隔）</label>
                        <input type="text" id="editTags" value="${currentNote.tags.join(', ')}">
                    </div>
                    <div class="form-group">
                        <label>内容</label>
                        <textarea id="editContent">${currentNote.content}</textarea>
                    </div>
                    <div class="form-actions">
                        <button class="btn" onclick="submitEdit()"><i class="fas fa-save"></i> 保存修改</button>
                        <button class="btn btn-secondary" onclick="hideEditForm()"><i class="fas fa-times"></i> 取消</button>
                    </div>
                </div>
                ` : `
                <div class="key-form" id="keyForm" style="display: none;">
                    <h3><i class="fas fa-key"></i> 输入笔记密钥</h3>
                    <div class="form-group">
                        <label>请输入修改密钥</label>
                        <input type="password" id="noteKeyInput" placeholder="输入笔记密钥">
                    </div>
                    <div class="form-actions">
                        <button class="btn" onclick="verifyKey()"><i class="fas fa-unlock"></i> 验证密钥</button>
                        <button class="btn btn-secondary" onclick="hideKeyForm()"><i class="fas fa-times"></i> 取消</button>
                    </div>
                </div>
                `}
            `;
        }

        // 格式化内容
        function formatContent(content) {
            const lines = content.split('\n');
            const html = [];
            let inCodeBlock = false;
            let codeLines = [];

            for (let i = 0; i < lines.length; i++) {
                let line = lines[i];

                // 代码块
                if (line.startsWith('```')) {
                    if (!inCodeBlock) {
                        inCodeBlock = true;
                        codeLines = [];
                    } else {
                        html.push(`<pre><code>${codeLines.join('\n')}</code></pre>`);
                        inCodeBlock = false;
                    }
                    continue;
                }

                if (inCodeBlock) {
                    codeLines.push(line);
                    continue;
                }

                // 列表
                if (line.match(/^\s*[-*+]\s/)) {
                    if (html[html.length - 1]?.startsWith('<ul>')) {
                        html[html.length - 1] += `<li>${line.replace(/^\s*[-*+]\s/, '')}</li>`;
                    } else {
                        html.push(`<ul><li>${line.replace(/^\s*[-*+]\s/, '')}</li></ul>`);
                    }
                    continue;
                }

                // 标题
                if (line.startsWith('#### ')) {
                    html.push(`<h4>${line.substring(5)}</h4>`);
                } else if (line.startsWith('### ')) {
                    html.push(`<h3>${line.substring(4)}</h3>`);
                } else if (line.startsWith('## ')) {
                    html.push(`<h2>${line.substring(3)}</h2>`);
                } else if (line.startsWith('# ')) {
                    html.push(`<h1>${line.substring(2)}</h1>`);
                }
                // 引用
                else if (line.startsWith('> ')) {
                    html.push(`<blockquote>${line.substring(2)}</blockquote>`);
                }
                // 分隔线
                else if (line.trim() === '---') {
                    html.push('<hr>');
                }
                // 空行
                else if (line.trim() === '') {
                    html.push('<br>');
                }
                // 普通段落
                else {
                    html.push(`<p>${line}</p>`);
                }
            }

            return html.join('');
        }

        // 加载评论
        function loadComments() {
            const noteId = currentNote.id;
            const storedComments = localStorage.getItem(`comments_${noteId}`);
            comments = storedComments ? JSON.parse(storedComments) : [];

            renderComments();
        }

        // 渲染评论
        function renderComments() {
            const commentList = document.getElementById('commentList');
            const commentCount = document.getElementById('commentCount');
            const commentsSection = document.getElementById('commentsSection');

            commentCount.textContent = comments.length;

            if (comments.length === 0) {
                commentList.innerHTML = `
                    <div class="empty-comments">
                        <i class="fas fa-comments"></i>
                        <p>暂无评论，来发表第一个评论吧！</p>
                    </div>
                `;
            } else {
                commentList.innerHTML = comments.map(comment => `
                    <div class="comment-item">
                        <div class="comment-header">
                            <div class="comment-avatar">${comment.author.charAt(0).toUpperCase()}</div>
                            <div>
                                <div class="comment-author">${escapeHtml(comment.author)}</div>
                                <div class="comment-date">${formatDate(comment.date)}</div>
                            </div>
                        </div>
                        <div class="comment-content">${escapeHtml(comment.content)}</div>
                    </div>
                `).join('');
            }

            commentsSection.style.display = 'block';
        }

        // 提交评论
        async function submitComment(e) {
            e.preventDefault();

            const author = document.getElementById('commentAuthor').value.trim() || '匿名用户';
            const content = document.getElementById('commentContent').value.trim();

            if (!content) {
                alert('请填写评论内容');
                return;
            }

            // 现在使用加密token，无需用户配置

            // 显示提交中状态
            const submitBtn = document.querySelector('.submit-btn');
            const originalText = submitBtn.innerHTML;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 提交中...';
            submitBtn.disabled = true;

            try {
                // 测试GitHub连接
                console.log('正在测试GitHub连接...');
                await githubNoteManager.testConnection();
                console.log('✅ GitHub连接成功');

                // 创建评论对象
                const comment = {
                    id: `comment-${Date.now()}`,
                    noteId: currentNote.id,
                    noteTitle: currentNote.title,
                    author,
                    content,
                    date: new Date().toISOString()
                };

                // 保存到GitHub
                console.log('正在保存评论...');
                await githubNoteManager.saveComment(comment);
                console.log('✅ 评论保存成功');

                // 同时保存到本地
                comments.unshift(comment);
                const noteId = currentNote.id;
                localStorage.setItem(`comments_${noteId}`, JSON.stringify(comments));

                // 显示成功消息
                showNotification('评论发表成功！感谢您的参与！', 'success');

                // 重新渲染评论
                renderComments();

                // 清空表单
                document.getElementById('commentForm').reset();

            } catch (error) {
                console.error('评论提交失败:', error);
                alert('评论提交失败: ' + error.message + '\\n\\n请稍后重试或联系管理员。');
            } finally {
                // 恢复按钮状态
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
            }
        }

        // 格式化日期
        function formatDate(dateString) {
            const date = new Date(dateString);
            const now = new Date();
            const diff = now - date;
            const minutes = Math.floor(diff / 60000);
            const hours = Math.floor(diff / 3600000);
            const days = Math.floor(diff / 86400000);

            if (minutes < 1) return '刚刚';
            if (minutes < 60) return `${minutes}分钟前`;
            if (hours < 24) return `${hours}小时前`;
            if (days < 7) return `${days}天前`;

            return date.toLocaleDateString('zh-CN', {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
        }

        // 转义HTML
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // 显示通知
        function showNotification(message, type) {
            const notification = document.createElement('div');
            notification.className = `notification notification-${type}`;
            notification.innerHTML = `
                <i class="fas fa-check-circle"></i>
                <span>${message}</span>
            `;

            const style = document.createElement('style');
            style.textContent = `
                .notification {
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    padding: 16px 24px;
                    border-radius: 12px;
                    color: #fff;
                    font-weight: 500;
                    display: flex;
                    align-items: center;
                    gap: 10px;
                    z-index: 1000;
                    animation: slideInRight 0.3s ease-out, slideOutRight 0.3s ease-in 2.7s;
                    max-width: 400px;
                    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
                    background: linear-gradient(135deg, #4ade80 0%, #22c55e 100%);
                }
                @keyframes slideInRight {
                    from { transform: translateX(400px); opacity: 0; }
                    to { transform: translateX(0); opacity: 1; }
                }
                @keyframes slideOutRight {
                    from { transform: translateX(0); opacity: 1; }
                    to { transform: translateX(400px); opacity: 0; }
                }
            `;
            if (!document.querySelector('style[data-notification]')) {
                style.setAttribute('data-notification', 'true');
                document.head.appendChild(style);
            }

            document.body.appendChild(notification);

            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        // 主题切换器
        function initThemeSwitcher() {
            const themeToggle = document.getElementById('themeToggle');
            const themePanel = document.getElementById('themePanel');
            const themeOptions = document.querySelectorAll('.theme-option');
            const body = document.body;

            const savedTheme = localStorage.getItem('theme') || 'violet';
            setTheme(savedTheme);

            themeToggle.addEventListener('click', (e) => {
                e.stopPropagation();
                themePanel.classList.toggle('open');
            });

            themeOptions.forEach(option => {
                option.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const theme = option.dataset.theme;
                    setTheme(theme);
                    themePanel.classList.remove('open');
                });
            });

            document.addEventListener('click', () => {
                themePanel.classList.remove('open');
            });

            function setTheme(theme) {
                body.setAttribute('data-theme', theme);
                localStorage.setItem('theme', theme);

                themeOptions.forEach(opt => {
                    opt.classList.toggle('active', opt.dataset.theme === theme);
                });

                body.style.transition = 'background 0.5s ease';
                setTimeout(() => {
                    body.style.transition = '';
                }, 500);
            }
        }

        // 显示修改表单
        function showEditForm() {
            const editForm = document.getElementById('editForm');
            if (editForm) {
                editForm.style.display = 'block';
            }
        }

        // 隐藏修改表单
        function hideEditForm() {
            const editForm = document.getElementById('editForm');
            if (editForm) {
                editForm.style.display = 'none';
            }
        }

        // 提交修改
        async function submitEdit() {
            const title = document.getElementById('editTitle').value.trim();
            const tagsStr = document.getElementById('editTags').value.trim();
            const content = document.getElementById('editContent').value.trim();

            if (!title || !content) {
                alert('请填写标题和内容');
                return;
            }

            const tags = tagsStr ? tagsStr.split(',').map(t => t.trim()).filter(t => t) : [];

            const updatedNote = {
                ...currentNote,
                title,
                content,
                tags,
                excerpt: content.substring(0, 100) + (content.length > 100 ? '...' : ''),
                date: new Date().toISOString().split('T')[0]
            };

            try {
                await githubNoteManager.updateNote(currentNote.id, updatedNote);
                alert('笔记修改成功！');
                window.location.reload();
            } catch (error) {
                console.error('修改失败:', error);
                alert('修改失败: ' + error.message);
            }
        }

        // 显示密钥输入表单
        function showKeyForm() {
            const keyForm = document.getElementById('keyForm');
            if (keyForm) {
                keyForm.style.display = 'block';
            }
        }

        // 隐藏密钥输入表单
        function hideKeyForm() {
            const keyForm = document.getElementById('keyForm');
            if (keyForm) {
                keyForm.style.display = 'none';
            }
        }

        // 验证密钥
        function verifyKey() {
            const inputKey = document.getElementById('noteKeyInput').value.trim();

            if (inputKey === currentNote.authorKey) {
                hideKeyForm();
                showEditForm();
            } else {
                alert('密钥错误！');
                document.getElementById('noteKeyInput').value = '';
            }
        }

        // 绑定事件
        function bindEvents() {
            const commentForm = document.getElementById('commentForm');
            commentForm.addEventListener('submit', submitComment);
        }

        // 页面加载完成后初始化
        window.addEventListener('load', () => {
            createBackgroundParticles();
            initMouseFollowParticles();
            loadNote();
            bindEvents();
            initThemeSwitcher();
        });
    </script>
</body>

</html>