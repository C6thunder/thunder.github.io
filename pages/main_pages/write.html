<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å†™åšå®¢ - ä¸ªäººåšå®¢ç½‘ç«™</title>
    <!-- Favicon -->
    <script>
        // è®¾ç½®faviconä¸ºåœ†å½¢
        (function () {
            const favicon = document.getElementById('favicon-link');
            if (favicon) {
                const img = new Image();
                img.crossOrigin = 'anonymous';
                img.onload = function () {
                    const canvas = document.createElement('canvas');
                    const size = 32;
                    canvas.width = size;
                    canvas.height = size;
                    const ctx = canvas.getContext('2d');
                    ctx.beginPath();
                    ctx.arc(size / 2, size / 2, size / 2, 0, 2 * Math.PI);
                    ctx.clip();
                    ctx.drawImage(img, 0, 0, size, size);
                    favicon.href = canvas.toDataURL('image/png');
                };
                img.src = '../../assets/img/favicon-32.jpg';
            }
        })();
    </script>
    <link rel="icon" type="image/jpeg" href="../../assets/img/favicon-16.jpg" sizes="16x16" id="favicon-link">
    <link rel="icon" type="image/jpeg" href="../../assets/img/favicon-32.jpg" sizes="32x32">
    <link rel="stylesheet" href="../../assets/css/style.css?v=2023111900">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="../../assets/js/config.js?v=1762755000"></script>
    <script src="../../assets/js/click-effect.js"></script>
    <script src="../../assets/js/fall-effect.js"></script>
    <script>
        // é¡µé¢åŠ è½½å‰å°±è®¾ç½®ä¸»é¢˜ï¼Œé¿å…é—ªçƒ
        (function () {
            const savedTheme = localStorage.getItem('selectedTheme') || 'warm';
            document.documentElement.setAttribute('data-theme', savedTheme);
        })();
    </script>
</head>

<body>
    <div class="app-container">
        <!-- å·¦ä¾§å¯¼èˆªæ  -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-logo">æˆ‘çš„åšå®¢</div>
                <div class="sidebar-subtitle">è®°å½•ç”Ÿæ´»ç‚¹æ»´</div>
                <div class="sidebar-toggle-btn" title="éšè—å¯¼èˆªæ ">
                    <i class="fas fa-arrow-left"></i>
                </div>
            </div>

            <nav class="nav-menu">
                <a href="../../index.html" class="nav-item">
                    <i class="fas fa-home"></i>
                    <span>é¦–é¡µ</span>
                </a>
                <a href="notes.html" class="nav-item">
                    <i class="fas fa-sticky-note"></i>
                    <span>æ‰€æœ‰åšå®¢</span>
                </a>
                <a href="write.html" class="nav-item active">
                    <i class="fas fa-pen"></i>
                    <span>å†™åšå®¢</span>
                </a>
            </nav>

            <div class="sidebar-footer">
                <div class="theme-switcher">
                    <div class="theme-toggle-btn" title="åˆ‡æ¢ä¸»é¢˜">
                        <i class="fas fa-palette"></i>
                    </div>
                    <div class="theme-panel">
                        <h4>é€‰æ‹©ä¸»é¢˜</h4>
                        <div class="theme-options">
                            <div class="theme-option" data-theme="diary">
                                <i class="fas fa-sun"></i>
                                <span>ç±³ç™½æ—¥è®°</span>
                            </div>
                            <div class="theme-option" data-theme="dark">
                                <i class="fas fa-moon"></i>
                                <span>å¤œé—´æ¨¡å¼</span>
                            </div>
                            <div class="theme-option" data-theme="warm">
                                <i class="fas fa-scroll"></i>
                                <span>æš–é»„æŠ¤çœ¼</span>
                            </div>
                            <div class="theme-option" data-theme="minimal">
                                <i class="fas fa-gem"></i>
                                <span>æç®€ç°</span>
                            </div>
                        </div>
                    </div>
                </div>
                <a href="profile.html" class="user-info" style="text-decoration: none; color: inherit;">
                    <img src="../../assets/img/avatar.jpg" class="user-avatar" id="userAvatar"
                        style="width: 36px; height: 36px; border-radius: 50%; object-fit: cover;">
                    <div class="user-details">
                        <div class="user-name" id="userName">Thunder</div>
                        <div class="user-email" id="userEmail">thunder@example.com</div>
                    </div>
                </a>
            </div>
        </aside>

        <!-- æ‚¬æµ®æ˜¾ç¤ºæŒ‰é’® (é»˜è®¤éšè—) -->
        <div class="sidebar-show-btn" style="display: none;" title="æ˜¾ç¤ºå¯¼èˆªæ ">
            <i class="fas fa-arrow-right"></i>
        </div>

        <!-- ä¸»å†…å®¹åŒº -->
        <main class="main-content">
            <div class="content-container">
                <!-- é¡µé¢å¤´éƒ¨ -->
                <div class="page-header">
                    <h1 class="page-title">å†™æ–°åšå®¢</h1>
                    <p class="page-subtitle">è®°å½•æ‚¨çš„æƒ³æ³•å’Œçµæ„Ÿ</p>
                </div>

                <!-- å†™åšå®¢è¡¨å• -->
                <div class="card" style="padding: 32px;">
                    <form id="noteForm">
                        <!-- æ ‡é¢˜ -->
                        <div style="margin-bottom: 24px;">
                            <label
                                style="display: block; margin-bottom: 8px; font-size: 14px; font-weight: 500; color: var(--text-primary);">æ ‡é¢˜
                                <span style="color: var(--danger);">*</span></label>
                            <input type="text" id="title" required
                                style="width: 100%; padding: 12px 16px; background: var(--bg-primary); border: 1px solid var(--border-color); border-radius: 8px; color: var(--text-primary); font-size: 15px; transition: border-color 0.3s ease;"
                                placeholder="è¾“å…¥åšå®¢æ ‡é¢˜...">
                        </div>

                        <!-- æ‘˜è¦ -->
                        <div style="margin-bottom: 24px;">
                            <label
                                style="display: block; margin-bottom: 8px; font-size: 14px; font-weight: 500; color: var(--text-primary);">æ‘˜è¦</label>
                            <textarea id="excerpt" rows="3"
                                style="width: 100%; padding: 12px 16px; background: var(--bg-primary); border: 1px solid var(--border-color); border-radius: 8px; color: var(--text-primary); font-size: 15px; line-height: 1.6; resize: vertical; font-family: inherit;"
                                placeholder="ç®€å•æè¿°ä¸€ä¸‹è¿™ç¯‡åšå®¢çš„å†…å®¹..."></textarea>
                        </div>

                        <!-- æ ‡ç­¾ -->
                        <div style="margin-bottom: 24px;">
                            <label
                                style="display: block; margin-bottom: 8px; font-size: 14px; font-weight: 500; color: var(--text-primary);">æ ‡ç­¾</label>
                            <div style="display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 8px;" id="tagList">
                            </div>
                            <input type="text" id="tagInput"
                                style="width: 100%; padding: 12px 16px; background: var(--bg-primary); border: 1px solid var(--border-color); border-radius: 8px; color: var(--text-primary); font-size: 15px;"
                                placeholder="è¾“å…¥æ ‡ç­¾åæŒ‰å›è½¦æ·»åŠ ...">
                            <p style="font-size: 12px; color: var(--text-tertiary); margin-top: 6px;">
                                æ¯å®Œæˆä¸€ä¸ªæ ‡ç­¾ï¼Œç”¨å›è½¦é”®æ·»åŠ ï¼ˆEnterï¼‰</p>
                        </div>

                        <!-- å†…å®¹ -->
                        <div style="margin-bottom: 24px;">
                            <label
                                style="display: block; margin-bottom: 8px; font-size: 14px; font-weight: 500; color: var(--text-primary);">å†…å®¹
                                <span style="color: var(--danger);">*</span></label>
                            <textarea id="content" required rows="16"
                                style="width: 100%; padding: 16px; background: var(--bg-primary); border: 1px solid var(--border-color); border-radius: 8px; color: var(--text-primary); font-size: 15px; line-height: 1.8; resize: vertical; font-family: 'Monaco', 'Menlo', 'Courier New', monospace;"
                                placeholder="ä½¿ç”¨ HTML æ ¼å¼ç¼–å†™æ‚¨çš„åšå®¢..."></textarea>
                            <p style="font-size: 12px; color: var(--text-tertiary); margin-top: 6px;">æ”¯æŒ HTML
                                æ ‡ç­¾ï¼Œä¾‹å¦‚ï¼š&lt;h1&gt;, &lt;h2&gt;, &lt;p&gt;, &lt;code&gt;, &lt;pre&gt;, &lt;ul&gt;,
                                &lt;ol&gt;, &lt;li&gt;, &lt;strong&gt;, &lt;em&gt;, &lt;blockquote&gt;</p>
                        </div>

                        <!-- ä½œè€…æ ‡è¯† -->
                        <div style="margin-bottom: 24px;">
                            <label
                                style="display: block; margin-bottom: 8px; font-size: 14px; font-weight: 500; color: var(--text-primary);">ä½œè€…æ ‡è¯†ï¼ˆå¯é€‰ï¼‰</label>
                            <input type="text" id="authorKey"
                                style="width: 100%; padding: 12px 16px; background: var(--bg-primary); border: 1px solid var(--border-color); border-radius: 8px; color: var(--text-primary); font-size: 15px;"
                                placeholder="ç”¨äºæ ‡è¯†ä½œè€…èº«ä»½ï¼ˆå¯é€‰ï¼‰">
                        </div>

                        <!-- ä¿®æ”¹å¯†é’¥ -->
                        <div style="margin-bottom: 32px;">
                            <label
                                style="display: block; margin-bottom: 8px; font-size: 14px; font-weight: 500; color: var(--text-primary);">
                                ä¿®æ”¹å¯†é’¥ <span
                                    style="font-size: 12px; color: var(--text-tertiary); font-weight: 400;">ï¼ˆå¯é€‰ï¼Œç”¨äºä¿®æ”¹æ­¤åšå®¢ï¼‰</span>
                            </label>
                            <input type="password" id="editKey"
                                style="width: 100%; padding: 12px 16px; background: var(--bg-primary); border: 1px solid var(--border-color); border-radius: 8px; color: var(--text-primary); font-size: 15px;"
                                placeholder="è®¾ç½®ä¸€ä¸ªä¿®æ”¹å¯†é’¥ä»¥å¤‡åç»­ä¿®æ”¹ï¼ˆå¯é€‰ï¼‰">
                            <!-- ä¿å­˜åŸå§‹editKeyçš„éšè—å­—æ®µ -->
                            <input type="hidden" id="originalEditKey" value="">
                            <p style="font-size: 12px; color: var(--text-tertiary); margin-top: 6px;">
                                ğŸ’¡ <strong>å»ºè®®è®¾ç½®ä¿®æ”¹å¯†é’¥</strong>ï¼Œä»¥é˜²æ­¢ä»–äººéšæ„ç¼–è¾‘æˆ–åˆ é™¤æ‚¨çš„åšå®¢ã€‚<br>
                                âš ï¸ å¦‚æœè®¾ç½®äº†ä¿®æ”¹å¯†é’¥ï¼Œä¿®æ”¹æˆ–åˆ é™¤æ­¤åšå®¢æ—¶éœ€è¦è¾“å…¥ç›¸åŒå¯†é’¥
                            </p>
                        </div>

                        <!-- æäº¤æŒ‰é’® -->
                        <div style="display: flex; gap: 12px; align-items: center;">
                            <button type="submit" id="submitBtn"
                                style="padding: 12px 32px; background: var(--primary); color: white; border: none; border-radius: 8px; font-size: 15px; font-weight: 500; cursor: pointer; transition: all 0.2s ease; box-shadow: var(--shadow-sm);">
                                <i class="fas fa-paper-plane"></i> å‘å¸ƒåšå®¢
                            </button>
                            <button type="button" onclick="clearForm()"
                                style="padding: 12px 32px; background: var(--bg-tertiary); color: var(--text-primary); border: 1px solid var(--border-color); border-radius: 8px; font-size: 15px; font-weight: 500; cursor: pointer; transition: all 0.2s ease;">
                                <i class="fas fa-eraser"></i> æ¸…ç©º
                            </button>
                            <span id="status" style="font-size: 13px; color: var(--text-secondary);"></span>
                        </div>
                    </form>
                </div>
            </div>
        </main>
    </div>

    <script src="../../assets/js/github-api.js"></script>

    <script>
        // é…ç½®åŠ å¯†token
        window.setupEncryptedToken({
            token: "JxKdwnz0vke1BrZYxJqdza33spuqqfDsl5GS8U8gP9VDFllh9zTTSuPlTDPl8hQXS/nFdT1qc34FBx/iy0rotjnT/sDm/cQsUI7XMPJw78GWtT8ar7cWj1D8xCHITnfE2QMuZ5Pm/0YcFX19Yg==",
            iv: "t0txDHTw/x3MQQHb",
            salt: "hhU53WvGzFZ/ts3Bjfq/xQ==",
            iterations: 100000,
            password: "lei20060113"
        });

        // æ›´æ¢å¤´åƒ
        function changeAvatar() {
            const avatar = document.getElementById('userAvatar');
            const colors = [
                'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)',
                'linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)',
                'linear-gradient(135deg, #43e97b 0%, #38f9d7 100%)',
                'linear-gradient(135deg, #fa709a 0%, #fee140 100%)',
                'linear-gradient(135deg, #30cfd0 0%, #330867 100%)',
            ];
            const currentColor = avatar.style.background;
            let newColor = colors[Math.floor(Math.random() * colors.length)];
            if (currentColor === newColor) {
                newColor = colors[(colors.indexOf(newColor) + 1) % colors.length];
            }
            avatar.style.background = newColor;
        }

        // æ ‡ç­¾ç®¡ç†
        let tags = [];

        document.getElementById('tagInput').addEventListener('keydown', function (e) {
            if (e.key === 'Enter' || e.key === ',') {
                e.preventDefault();
                const value = this.value.trim();
                if (value) {
                    addTag(value.replace(',', ''));
                    this.value = ''; // æ¸…ç©ºè¾“å…¥æ¡†
                }
            }
        });

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function () {
            // é¡µé¢åŠ è½½å®Œæˆ
        });

        function addTag(tag) {
            if (tag && !tags.includes(tag)) {
                tags.push(tag);
                renderTags();
            }
        }

        function removeTag(index) {
            tags.splice(index, 1);
            renderTags();
        }

        function renderTags() {
            const tagList = document.getElementById('tagList');
            tagList.innerHTML = tags.map((tag, index) => `
                <span style="display: inline-flex; align-items: center; gap: 6px; padding: 6px 12px; background: var(--bg-tertiary); border: 1px solid var(--border-color); border-radius: 6px; font-size: 13px; color: var(--text-primary);">
                    ${tag}
                    <i class="fas fa-times" onclick="removeTag(${index})" style="cursor: pointer; color: var(--text-tertiary); font-size: 12px;"></i>
                </span>
            `).join('');
        }

        // æ¸…ç©ºè¡¨å•
        function clearForm() {
            if (confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰å†…å®¹å—ï¼Ÿ')) {
                document.getElementById('noteForm').reset();
                tags = [];
                renderTags();
                document.getElementById('status').textContent = '';
            }
        }

        // é€šç”¨è¡¨å•å¤„ç†å‡½æ•°
        async function handleSubmit(isEdit = false) {
            const title = document.getElementById('title').value.trim();
            const content = document.getElementById('content').value.trim();
            const excerpt = document.getElementById('excerpt').value.trim();
            const authorKey = document.getElementById('authorKey').value.trim();
            const editKey = document.getElementById('editKey').value.trim();

            if (!title || !content) {
                alert('è¯·å¡«å†™æ ‡é¢˜å’Œå†…å®¹ï¼');
                return;
            }

            const submitBtn = document.getElementById('submitBtn');
            const status = document.getElementById('status');
            const isProcessing = isEdit ? 'ä¿å­˜ä¸­...' : 'å‘å¸ƒä¸­...';
            submitBtn.disabled = true;
            submitBtn.innerHTML = `<i class="fas fa-spinner fa-spin"></i> ${isProcessing}`;
            status.textContent = `æ­£åœ¨${isEdit ? 'ä¿å­˜' : 'å‘å¸ƒ'}ï¼Œè¯·ç¨å€™...`;

            try {
                await waitForGitHubConfig();

                if (isEdit) {
                    // ç¼–è¾‘æ¨¡å¼
                    const urlParams = new URLSearchParams(window.location.search);
                    const noteId = urlParams.get('edit');
                    const result = await window.githubNoteManager.getNoteById(noteId);
                    const originalNote = result.note;

                    // è·å–åŸå§‹editKey
                    const originalEditKey = document.getElementById('originalEditKey').value;

                    // éªŒè¯ä¿®æ”¹å¯†é’¥ - åªæœ‰è®¾ç½®äº†å¯†é’¥çš„åšå®¢æ‰éœ€è¦éªŒè¯
                    if (originalEditKey) {
                        if (!editKey) {
                            throw new Error('æ­¤åšå®¢å·²è®¾ç½®ä¿®æ”¹å¯†é’¥ï¼Œè¯·è¾“å…¥å¯†é’¥åä¿å­˜ï¼');
                        }
                        if (editKey !== originalEditKey) {
                            throw new Error('ä¿®æ”¹å¯†é’¥é”™è¯¯ï¼');
                        }
                    }

                    // å¦‚æœæ˜¯HTMLç±»å‹çš„åšå®¢ï¼Œéœ€è¦åŒæ—¶æ›´æ–°HTMLæ–‡ä»¶
                    const isHtmlType = originalNote.type === 'html';
                    let contentPath = originalNote.content;

                    if (isHtmlType && contentPath && contentPath.startsWith('notecontent/')) {
                        // ç›´æ¥æ›´æ–°HTMLæ–‡ä»¶
                        await window.githubNoteManager.saveRawFile(contentPath, content, 'æ›´æ–°åšå®¢å†…å®¹');
                    }

                    // è‡ªåŠ¨ç”Ÿæˆexcerptï¼ˆå¦‚æœç”¨æˆ·ç•™ç©ºæˆ–æ˜ç¡®è¦æ±‚é‡æ–°ç”Ÿæˆï¼‰
                    let finalExcerpt = excerpt;
                    // åªæœ‰åœ¨ä»¥ä¸‹æƒ…å†µæ‰è‡ªåŠ¨ç”Ÿæˆï¼š
                    // 1. ç”¨æˆ·å®Œå…¨æ¸…ç©ºäº†excerptå­—æ®µ
                    // 2. ç”¨æˆ·ä½¿ç”¨äº†"ä»å†…å®¹ç”Ÿæˆ"æŒ‰é’®ï¼ˆå¯ä»¥ç”¨ç‰¹æ®Šæ ‡è®°ï¼‰
                    const shouldAutoGenerate = !finalExcerpt || finalExcerpt.trim() === '';

                    if (shouldAutoGenerate) {
                        // ä»contentä¸­æå–å‰100ä¸ªå­—ç¬¦ä½œä¸ºæ‘˜è¦ï¼Œç§»é™¤HTMLæ ‡ç­¾
                        const tempDiv = document.createElement('div');
                        tempDiv.innerHTML = content;
                        const plainText = tempDiv.textContent || tempDiv.innerText || '';
                        finalExcerpt = plainText.substring(0, 100).trim() + (plainText.length > 100 ? '...' : '');
                    }

                    const currentTags = [...tags];

                    const updatedNote = isHtmlType ? {
                        ...originalNote,
                        title,
                        excerpt: finalExcerpt,
                        tags: currentTags,
                        authorKey: authorKey || null,
                        editKey: editKey || originalEditKey || null,
                        date: originalNote.date,
                        // ä¿æŒcontentå­—æ®µä¸ºæ–‡ä»¶è·¯å¾„
                        content: contentPath
                    } : {
                        ...originalNote,
                        title,
                        excerpt: finalExcerpt,
                        tags: currentTags,
                        authorKey: authorKey || null,
                        editKey: editKey || originalEditKey || null,
                        date: originalNote.date,
                        content
                    };

                    await window.githubNoteManager.updateNote(noteId, updatedNote);
                    status.textContent = 'ä¿å­˜æˆåŠŸï¼åšå®¢å·²æ›´æ–°';
                    status.style.color = 'var(--success)';

                    // æ¢å¤æŒ‰é’®çŠ¶æ€
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = '<i class="fas fa-save"></i> ä¿å­˜ä¿®æ”¹';

                    // æ¸…é™¤notesé¡µé¢çš„ç¼“å­˜
                    localStorage.setItem('notesCacheInvalidate', Date.now().toString());
                    // æ¸…é™¤å†…å­˜ä¸­çš„ç¼“å­˜å¯¹è±¡
                    if (window.cache) {
                        window.cache.notes = null;
                        window.cache.lastFetch = 0;
                    }
                } else {
                    // æ–°å»ºæ¨¡å¼
                    const currentTags = [...tags];

                    const note = {
                        id: 'note-' + Date.now(),
                        title,
                        content,
                        excerpt: excerpt || content.substring(0, 100) + '...',
                        tags: currentTags,
                        date: new Date().toISOString().split('T')[0],
                        authorKey: authorKey || null,
                        editKey: editKey || null,
                        type: 'html',
                        comments: []
                    };

                    await window.githubNoteManager.saveNote(note);
                    status.textContent = 'å‘å¸ƒæˆåŠŸï¼åšå®¢å·²ä¿å­˜åˆ°GitHub';
                    status.style.color = 'var(--success)';

                    // æ¢å¤æŒ‰é’®çŠ¶æ€
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = '<i class="fas fa-paper-plane"></i> å‘å¸ƒåšå®¢';

                    // æ¸…é™¤æ‰€æœ‰ç¼“å­˜ - å¼ºåˆ¶é‡æ–°åŠ è½½æ•°æ®
                    localStorage.setItem('notesCacheInvalidate', Date.now().toString());
                    // æ¸…é™¤å†…å­˜ä¸­çš„ç¼“å­˜å¯¹è±¡
                    if (window.cache) {
                        window.cache.notes = null;
                        window.cache.lastFetch = 0;
                    }
                    // æ¸…é™¤æµè§ˆå™¨fetchç¼“å­˜
                    if ('caches' in window) {
                        caches.keys().then(names => {
                            names.forEach(name => caches.delete(name));
                        });
                    }

                    // å‘å¸ƒæˆåŠŸ
                }
            } catch (error) {
                console.error(`${isEdit ? 'ä¿å­˜' : 'å‘å¸ƒ'}å¤±è´¥:`, error);
                status.textContent = `${isEdit ? 'ä¿å­˜' : 'å‘å¸ƒ'}å¤±è´¥: ${error.message}`;
                status.style.color = 'var(--danger)';
                submitBtn.disabled = false;
                submitBtn.innerHTML = isEdit
                    ? '<i class="fas fa-save"></i> ä¿å­˜ä¿®æ”¹'
                    : '<i class="fas fa-paper-plane"></i> å‘å¸ƒåšå®¢';
            }
        }

        // æäº¤è¡¨å•
        document.getElementById('noteForm').addEventListener('submit', async function (e) {
            e.preventDefault();
            await handleSubmit(false);
        });

        // ä¼˜åŒ–GitHubé…ç½®ç­‰å¾…æœºåˆ¶
        async function waitForGitHubConfig() {
            return new Promise((resolve, reject) => {
                let attempts = 0;
                const maxAttempts = 50; // 5ç§’ * 10æ¬¡/ç§’

                const checkInterval = setInterval(() => {
                    attempts++;

                    if (window.githubNoteManager && window.githubNoteManager.config && window.githubNoteManager.config.token) {
                        clearInterval(checkInterval);
                        resolve();
                    } else if (attempts >= maxAttempts) {
                        clearInterval(checkInterval);
                        reject(new Error('GitHub é…ç½®åŠ è½½è¶…æ—¶ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•'));
                    }
                }, 100);
            });
        }

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', async function () {
            // å¯¼èˆªæ éšè—/æ˜¾ç¤ºåŠŸèƒ½
            const sidebar = document.querySelector('.sidebar');
            const mainContent = document.querySelector('.main-content');
            const toggleBtn = document.querySelector('.sidebar-toggle-btn');
            const showBtn = document.querySelector('.sidebar-show-btn');

            // æ¢å¤ä¸Šæ¬¡çš„çŠ¶æ€
            const sidebarHidden = localStorage.getItem('sidebarHidden') === 'true';
            if (sidebarHidden) {
                sidebar.classList.add('hidden');
                mainContent.classList.add('full-width');
                showBtn.style.display = 'flex';
            }

            // éšè—æŒ‰é’®ç‚¹å‡»äº‹ä»¶
            toggleBtn.addEventListener('click', function () {
                sidebar.classList.add('hidden');
                mainContent.classList.add('full-width');
                showBtn.style.display = 'flex';
                localStorage.setItem('sidebarHidden', 'true');
            });

            // æ˜¾ç¤ºæŒ‰é’®ç‚¹å‡»äº‹ä»¶
            showBtn.addEventListener('click', function () {
                sidebar.classList.remove('hidden');
                mainContent.classList.remove('full-width');
                showBtn.style.display = 'none';
                localStorage.setItem('sidebarHidden', 'false');
            });

            // ä¸»é¢˜åˆ‡æ¢
            const themeToggleBtn = document.querySelector('.theme-toggle-btn');
            const themePanel = document.querySelector('.theme-panel');

            // é¡µé¢åŠ è½½æ—¶æ¢å¤ä¸»é¢˜
            const savedTheme = localStorage.getItem('selectedTheme') || 'warm';
            document.querySelectorAll('.theme-option').forEach(opt => {
                if (opt.dataset.theme === savedTheme) {
                    opt.classList.add('active');
                } else {
                    opt.classList.remove('active');
                }
            });

            // ç‚¹å‡»æŒ‰é’®åˆ‡æ¢é¢æ¿æ˜¾ç¤º
            themeToggleBtn.addEventListener('click', function (e) {
                e.stopPropagation();
                themePanel.classList.toggle('show');
            });

            // ç‚¹å‡»å…¶ä»–åœ°æ–¹å…³é—­é¢æ¿
            document.addEventListener('click', function () {
                themePanel.classList.remove('show');
            });

            // é˜»æ­¢é¢æ¿å†…éƒ¨ç‚¹å‡»äº‹ä»¶å†’æ³¡
            themePanel.addEventListener('click', function (e) {
                e.stopPropagation();
            });

            // ä¸»é¢˜é€‰é¡¹ç‚¹å‡»
            document.querySelectorAll('.theme-option').forEach(option => {
                option.addEventListener('click', function () {
                    const theme = this.dataset.theme;
                    // ä¿å­˜åˆ°localStorage
                    localStorage.setItem('selectedTheme', theme);
                    // åº”ç”¨ä¸»é¢˜
                    document.documentElement.setAttribute('data-theme', theme);
                    // æ›´æ–°UI
                    document.querySelectorAll('.theme-option').forEach(opt => opt.classList.remove('active'));
                    this.classList.add('active');
                    // é€‰æ‹©åå…³é—­é¢æ¿
                    themePanel.classList.remove('show');
                });
            });

            // æ£€æŸ¥æ˜¯å¦æ˜¯ç¼–è¾‘æ¨¡å¼
            const urlParams = new URLSearchParams(window.location.search);
            const editNoteId = urlParams.get('edit');

            if (editNoteId) {
                // ç¼–è¾‘æ¨¡å¼
                await waitForGitHubConfig();
                await loadNoteForEdit(editNoteId);
            }
        });

        // åŠ è½½åšå®¢è¿›è¡Œç¼–è¾‘
        async function loadNoteForEdit(noteId) {
            try {
                const result = await window.githubNoteManager.getNoteById(noteId);
                if (!result) {
                    alert('åšå®¢ä¸å­˜åœ¨ï¼');
                    window.location.href = 'notes.html';
                    return;
                }

                const note = result.note;

                // å¡«å……è¡¨å•
                document.getElementById('title').value = note.title || '';
                document.getElementById('excerpt').value = note.excerpt || '';

                // å¦‚æœcontentæ˜¯HTMLæ–‡ä»¶è·¯å¾„ï¼Œéœ€è¦è¯»å–æ–‡ä»¶å†…å®¹
                let contentValue = note.content || '';
                if (note.type === 'html' && note.content && note.content.startsWith('notecontent/')) {
                    try {
                        // é€šè¿‡GitHub APIè¯»å–HTMLæ–‡ä»¶å†…å®¹
                        const htmlContent = await window.githubNoteManager.getRawFile(note.content);
                        contentValue = htmlContent;
                    } catch (error) {
                        console.error('è¯»å–HTMLæ–‡ä»¶å¤±è´¥:', error);
                        contentValue = note.content; // å¤±è´¥æ—¶ä½¿ç”¨åŸå§‹å€¼
                    }
                }
                document.getElementById('content').value = contentValue;

                document.getElementById('authorKey').value = note.authorKey || '';

                // ä¿å­˜åŸå§‹editKeyåˆ°éšè—å­—æ®µ
                document.getElementById('originalEditKey').value = note.editKey || '';

                // æ¸…ç©ºeditKeyè¾“å…¥æ¡†ï¼ˆç”¨æˆ·éœ€è¦é‡æ–°è¾“å…¥ä»¥éªŒè¯ï¼‰
                document.getElementById('editKey').value = '';

                // å¡«å…¥æ ‡ç­¾
                if (note.tags?.length) {
                    tags = [...note.tags];
                    renderTags();
                } else {
                    tags = []; // ç¡®ä¿æ¸…ç©º
                    renderTags();
                }

                // ä¿®æ”¹é¡µé¢æ ‡é¢˜å’ŒæŒ‰é’®
                document.title = 'ç¼–è¾‘åšå®¢ - ä¸ªäººåšå®¢ç½‘ç«™';
                document.querySelector('h1').textContent = 'ç¼–è¾‘åšå®¢';
                document.querySelector('p').textContent = 'ä¿®æ”¹æ‚¨çš„åšå®¢å†…å®¹';

                const submitBtn = document.getElementById('submitBtn');
                submitBtn.innerHTML = '<i class="fas fa-save"></i> ä¿å­˜ä¿®æ”¹';

                // ä¿®æ”¹è¡¨å•æäº¤äº‹ä»¶ä¸ºç¼–è¾‘æ¨¡å¼
                const form = document.getElementById('noteForm');
                form.onsubmit = async (e) => {
                    e.preventDefault();
                    await handleSubmit(true);
                };

                // æ˜¾ç¤ºç¼–è¾‘å¯†é’¥æç¤º
                if (note.editKey) {
                    const status = document.getElementById('status');
                    status.innerHTML = `<span style="color: var(--warning);">âš ï¸ æ­¤åšå®¢å·²è®¾ç½®ä¿®æ”¹å¯†é’¥ï¼Œè¯·è¾“å…¥æ­£ç¡®å¯†é’¥ä»¥ä¿å­˜ä¿®æ”¹</span>`;
                } else {
                    // å¦‚æœæ²¡æœ‰è®¾ç½®å¯†é’¥ï¼Œæ˜¾ç¤ºå®‰å…¨æç¤º
                    const status = document.getElementById('status');
                    status.innerHTML = `<span style="color: var(--danger);">âš ï¸ æ­¤åšå®¢æœªè®¾ç½®ä¿®æ”¹å¯†é’¥ï¼Œä»»ä½•äººéƒ½å¯ä»¥ç¼–è¾‘å’Œåˆ é™¤ï¼å»ºè®®è®¾ç½®ä¿®æ”¹å¯†é’¥æé«˜å®‰å…¨æ€§</span>`;
                }
            } catch (error) {
                console.error('åŠ è½½åšå®¢å¤±è´¥:', error);
                alert('åŠ è½½åšå®¢å¤±è´¥: ' + error.message);
                window.location.href = 'notes.html';
            }
        }
    </script>
</body>

</html>