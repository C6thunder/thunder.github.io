<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ‰€æœ‰åšå®¢ - ä¸ªäººåšå®¢ç½‘ç«™</title>
    <!-- Favicon -->
    <link rel="icon" type="image/jpeg" href="img/favicon-16.jpg" sizes="16x16" id="favicon-link">
    <link rel="icon" type="image/jpeg" href="img/favicon-32.jpg" sizes="32x32">
    <script>
        // è®¾ç½®faviconä¸ºåœ†å½¢
        (function() {
            const favicon = document.getElementById('favicon-link');
            if (favicon) {
                const img = new Image();
                img.crossOrigin = 'anonymous';
                img.onload = function() {
                    const canvas = document.createElement('canvas');
                    const size = 32;
                    canvas.width = size;
                    canvas.height = size;
                    const ctx = canvas.getContext('2d');
                    ctx.beginPath();
                    ctx.arc(size / 2, size / 2, size / 2, 0, 2 * Math.PI);
                    ctx.clip();
                    ctx.drawImage(img, 0, 0, size, size);
                    favicon.href = canvas.toDataURL('image/png');
                };
                img.src = 'img/favicon-32.jpg';
            }
        })();
    </script>
    <link rel="stylesheet" href="style.css?v=2023111900">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="config.js?v=1762755000"></script>
    <script src="click-effect.js"></script>
    <script>
        // é¡µé¢åŠ è½½å‰å°±è®¾ç½®ä¸»é¢˜ï¼Œé¿å…é—ªçƒ
        (function() {
            const savedTheme = localStorage.getItem('selectedTheme') || 'warm';
            document.documentElement.setAttribute('data-theme', savedTheme);
        })();
    </script>
</head>

<body>
    <div class="app-container">
        <!-- å·¦ä¾§å¯¼èˆªæ  -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-logo">æˆ‘çš„åšå®¢</div>
                <div class="sidebar-subtitle">è®°å½•ç”Ÿæ´»ç‚¹æ»´</div>
                <div class="sidebar-toggle-btn" title="éšè—å¯¼èˆªæ ">
                    <i class="fas fa-arrow-left"></i>
                </div>
            </div>

            <nav class="nav-menu">
                <a href="index.html" class="nav-item">
                    <i class="fas fa-home"></i>
                    <span>é¦–é¡µ</span>
                </a>
                <a href="notes.html" class="nav-item active">
                    <i class="fas fa-sticky-note"></i>
                    <span>æ‰€æœ‰åšå®¢</span>
                </a>
                <a href="write.html" class="nav-item">
                    <i class="fas fa-pen"></i>
                    <span>å†™åšå®¢</span>
                </a>
            </nav>

            <div class="sidebar-footer">
                <div class="theme-switcher">
                    <div class="theme-toggle-btn" title="åˆ‡æ¢ä¸»é¢˜">
                        <i class="fas fa-palette"></i>
                    </div>
                    <div class="theme-panel">
                        <h4>é€‰æ‹©ä¸»é¢˜</h4>
                        <div class="theme-options">
                            <div class="theme-option" data-theme="diary">
                                <i class="fas fa-sun"></i>
                                <span>ç±³ç™½æ—¥è®°</span>
                            </div>
                            <div class="theme-option" data-theme="dark">
                                <i class="fas fa-moon"></i>
                                <span>å¤œé—´æ¨¡å¼</span>
                            </div>
                            <div class="theme-option" data-theme="warm">
                                <i class="fas fa-scroll"></i>
                                <span>æš–é»„æŠ¤çœ¼</span>
                            </div>
                            <div class="theme-option" data-theme="minimal">
                                <i class="fas fa-gem"></i>
                                <span>æç®€ç°</span>
                            </div>
                        </div>
                    </div>
                </div>
                <a href="profile.html" class="user-info" style="text-decoration: none; color: inherit;">
                    <img src="img/avatar.jpg" class="user-avatar" id="userAvatar" style="width: 36px; height: 36px; border-radius: 50%; object-fit: cover;" data-config="avatar">
                    <div class="user-details">
                        <div class="user-name" id="userName">Thunder</div>
                        <div class="user-email" id="userEmail">thunder@example.com</div>
                    </div>
                </a>
            </div>
        </aside>

        <!-- æ‚¬æµ®æ˜¾ç¤ºæŒ‰é’® (é»˜è®¤éšè—) -->
        <div class="sidebar-show-btn" style="display: none;" title="æ˜¾ç¤ºå¯¼èˆªæ ">
            <i class="fas fa-arrow-right"></i>
        </div>

        <!-- ä¸»å†…å®¹åŒº -->
        <main class="main-content">
            <div class="content-container">
                <!-- é¡µé¢å¤´éƒ¨ -->
                <div class="page-header">
                    <h1 class="page-title">æ‰€æœ‰åšå®¢</h1>
                    <p class="page-subtitle">æµè§ˆå’Œç®¡ç†æ‚¨çš„æ‰€æœ‰åšå®¢</p>
                </div>

                <!-- å·¥å…·æ  -->
                <div class="card" style="padding: 16px; margin-bottom: 24px; display: flex; gap: 12px; align-items: center; flex-wrap: wrap;">
                    <a href="write.html" class="btn btn-primary" style="text-decoration: none;">
                        <i class="fas fa-plus"></i> å†™åšå®¢
                    </a>
                    <button class="btn btn-secondary" id="sortBtn">
                        <i class="fas fa-sort"></i> æ’åº
                    </button>
                    <button class="btn btn-secondary" id="refreshBtn" title="åˆ·æ–°åšå®¢">
                        <i class="fas fa-sync-alt"></i> åˆ·æ–°
                    </button>
                    <span class="last-update" id="lastUpdate" style="margin-left: auto; font-size: 12px; color: var(--text-tertiary);"></span>
                </div>

                <!-- æœç´¢æ  -->
                <div class="search-container" style="margin-bottom: 24px;">
                    <div class="search-box" style="background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 8px; padding: 12px 16px; display: flex; align-items: center; gap: 8px;">
                        <i class="fas fa-search" style="color: var(--text-tertiary);"></i>
                        <input type="text" id="searchInput" placeholder="æœç´¢åšå®¢ã€æ ‡ç­¾æˆ–å†…å®¹..." style="border: none; background: transparent; outline: none; color: var(--text-primary); flex: 1; font-size: 14px;">
                    </div>
                </div>

                <!-- ç­›é€‰æ ‡ç­¾ -->
                <div class="filter-tags" id="filterTags" style="margin-bottom: 24px;">
                    <div class="loading" style="color: var(--text-secondary);">åŠ è½½ä¸­...</div>
                </div>

                <!-- åšå®¢åˆ—è¡¨ -->
                <div class="notes-list" id="notesGrid">
                    <div class="loading" style="color: var(--text-secondary); text-align: center; padding: 40px;">åŠ è½½ä¸­...</div>
                </div>

                <!-- ç©ºçŠ¶æ€ -->
                <div class="empty-state" id="emptyState" style="display: none; text-align: center; padding: 60px 20px;">
                    <i class="fas fa-search" style="font-size: 48px; color: var(--text-tertiary); margin-bottom: 16px;"></i>
                    <h3 style="color: var(--text-primary); margin-bottom: 8px;">æœªæ‰¾åˆ°ç›¸å…³åšå®¢</h3>
                    <p style="color: var(--text-secondary); margin-bottom: 20px;">å°è¯•æ›´æ¢å…³é”®è¯æˆ–æ¸…é™¤ç­›é€‰æ¡ä»¶</p>
                    <button class="btn btn-primary" onclick="clearFilters()">æ¸…é™¤ç­›é€‰</button>
                </div>
            </div>
        </main>
    </div>

    <script src="github-api.js?v=1762760999"></script>

    <script>
        // é…ç½®åŠ å¯†token
        window.setupEncryptedToken({
            token: "JxKdwnz0vke1BrZYxJqdza33spuqqfDsl5GS8U8gP9VDFllh9zTTSuPlTDPl8hQXS/nFdT1qc34FBx/iy0rotjnT/sDm/cQsUI7XMPJw78GWtT8ar7cWj1D8xCHITnfE2QMuZ5Pm/0YcFX19Yg==",
            iv: "t0txDHTw/x3MQQHb",
            salt: "hhU53WvGzFZ/ts3Bjfq/xQ==",
            iterations: 100000,
            password: "lei20060113"
        });
    </script>

    <script>
        // å…¨å±€å˜é‡
        let allNotes = [];
        let filteredNotes = [];
        let currentPage = 1;
        const notesPerPage = 12;
        let currentSort = 'date-desc';
        let currentFilter = null;
        let currentSearch = '';

        // æœ¬åœ°ç¼“å­˜
        const cache = {
            notes: null,
            lastFetch: 0,
            ttl: 5 * 60 * 1000 // 5åˆ†é’Ÿç¼“å­˜
        };

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', async function() {
            // å¯¼èˆªæ éšè—/æ˜¾ç¤ºåŠŸèƒ½
            const sidebar = document.querySelector('.sidebar');
            const mainContent = document.querySelector('.main-content');
            const toggleBtn = document.querySelector('.sidebar-toggle-btn');
            const showBtn = document.querySelector('.sidebar-show-btn');

            // æ¢å¤ä¸Šæ¬¡çš„çŠ¶æ€
            const sidebarHidden = localStorage.getItem('sidebarHidden') === 'true';
            if (sidebarHidden) {
                sidebar.classList.add('hidden');
                mainContent.classList.add('full-width');
                showBtn.style.display = 'flex';
            }

            // éšè—æŒ‰é’®ç‚¹å‡»äº‹ä»¶
            toggleBtn.addEventListener('click', function() {
                sidebar.classList.add('hidden');
                mainContent.classList.add('full-width');
                showBtn.style.display = 'flex';
                localStorage.setItem('sidebarHidden', 'true');
            });

            // æ˜¾ç¤ºæŒ‰é’®ç‚¹å‡»äº‹ä»¶
            showBtn.addEventListener('click', function() {
                sidebar.classList.remove('hidden');
                mainContent.classList.remove('full-width');
                showBtn.style.display = 'none';
                localStorage.setItem('sidebarHidden', 'false');
            });

            try {
                await waitForGitHubConfig();

                // æ£€æŸ¥æ˜¯å¦æœ‰å…¶ä»–é¡µé¢è§¦å‘çš„ç¼“å­˜å¤±æ•ˆ
                const invalidateFlag = localStorage.getItem('notesCacheInvalidate');
                const urlParams = new URLSearchParams(window.location.search);
                const forceRefresh = urlParams.has('refresh') || urlParams.has('fromWrite');

                // æ¸…é™¤ç¼“å­˜çš„æƒ…å†µï¼š
                // 1. localStorageä¸­æœ‰invalidateFlag
                // 2. URLä¸­æœ‰refreshå‚æ•°
                // 3. URLä¸­æœ‰fromWriteå‚æ•°ï¼ˆä»å†™åšå®¢é¡µé¢è·³è½¬å›æ¥ï¼‰
                if (invalidateFlag || forceRefresh) {
                    console.log('ğŸ”„ æ¸…é™¤ç¼“å­˜ï¼Œé‡æ–°åŠ è½½æ•°æ®...');
                    cache.notes = null;
                    cache.lastFetch = 0;
                    localStorage.removeItem('notesCacheInvalidate');

                    // æ¸…é™¤æµè§ˆå™¨fetchç¼“å­˜
                    if ('caches' in window) {
                        caches.keys().then(names => {
                            names.forEach(name => caches.delete(name));
                        });
                    }

                    // æ¸…é™¤URLå‚æ•°ï¼Œé¿å…åˆ·æ–°é¡µé¢æ—¶å†æ¬¡å¼ºåˆ¶åˆ·æ–°
                    const newUrl = window.location.origin + window.location.pathname;
                    window.history.replaceState({}, document.title, newUrl);
                }

                await loadNotes();

                // ä¸»é¢˜åˆ‡æ¢
                const themeToggleBtn = document.querySelector('.theme-toggle-btn');
                const themePanel = document.querySelector('.theme-panel');

                // é¡µé¢åŠ è½½æ—¶æ¢å¤ä¸»é¢˜
                const savedTheme = localStorage.getItem('selectedTheme') || 'warm';

                // æ›´æ–°ä¸»é¢˜é€‰é¡¹çŠ¶æ€
                document.querySelectorAll('.theme-option').forEach(opt => {
                    if (opt.dataset.theme === savedTheme) {
                        opt.classList.add('active');
                    } else {
                        opt.classList.remove('active');
                    }
                });

                // ç‚¹å‡»æŒ‰é’®åˆ‡æ¢é¢æ¿æ˜¾ç¤º
                themeToggleBtn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    themePanel.classList.toggle('show');
                });

                // ç‚¹å‡»å…¶ä»–åœ°æ–¹å…³é—­é¢æ¿
                document.addEventListener('click', function() {
                    themePanel.classList.remove('show');
                });

                // é˜»æ­¢é¢æ¿å†…éƒ¨ç‚¹å‡»äº‹ä»¶å†’æ³¡
                themePanel.addEventListener('click', function(e) {
                    e.stopPropagation();
                });

                // ä¸»é¢˜é€‰é¡¹ç‚¹å‡»
                document.querySelectorAll('.theme-option').forEach(option => {
                    option.addEventListener('click', function() {
                        const theme = this.dataset.theme;
                        // ä¿å­˜åˆ°localStorage
                        localStorage.setItem('selectedTheme', theme);
                        // åº”ç”¨ä¸»é¢˜
                        document.documentElement.setAttribute('data-theme', theme);
                        // æ›´æ–°UI
                        document.querySelectorAll('.theme-option').forEach(opt => opt.classList.remove('active'));
                        this.classList.add('active');
                        // é€‰æ‹©åå…³é—­é¢æ¿
                        themePanel.classList.remove('show');
                    });
                });
            } catch (error) {
                console.error('åŠ è½½åšå®¢å¤±è´¥:', error);
                document.getElementById('notesGrid').innerHTML =
                    '<div style="text-align: center; padding: 40px; color: var(--danger);">' + error.message + '</div>';
            }
        });

        // ä¼˜åŒ–GitHubé…ç½®ç­‰å¾…æœºåˆ¶
        async function waitForGitHubConfig() {
            return new Promise((resolve, reject) => {
                let attempts = 0;
                const maxAttempts = 50; // 5ç§’ * 10æ¬¡/ç§’

                const checkInterval = setInterval(() => {
                    attempts++;

                    if (window.githubNoteManager && window.githubNoteManager.config && window.githubNoteManager.config.token) {
                        clearInterval(checkInterval);
                        resolve();
                    } else if (attempts >= maxAttempts) {
                        clearInterval(checkInterval);
                        reject(new Error('GitHub é…ç½®åŠ è½½è¶…æ—¶ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•'));
                    }
                }, 100);
            });
        }

        // åŠ è½½åšå®¢ï¼ˆä½¿ç”¨ç¼“å­˜ï¼‰
        async function loadNotes() {
            const notesGrid = document.getElementById('notesGrid');
            notesGrid.innerHTML = '<div style="text-align: center; padding: 40px; color: var(--text-secondary);">åŠ è½½ä¸­...</div>';

            try {
                if (!window.githubNoteManager || !window.githubNoteManager.config.token) {
                    throw new Error('GitHubé…ç½®æœªå°±ç»ª');
                }

                // æ£€æŸ¥ç¼“å­˜ - ä½†å¯¹äºæ–°åšå®¢æˆ–åˆ·æ–°è¯·æ±‚ï¼Œå¼ºåˆ¶é‡æ–°åŠ è½½
                const urlParams = new URLSearchParams(window.location.search);
                const forceRefresh = urlParams.has('refresh') || urlParams.has('fromWrite');
                const now = Date.now();

                if (cache.notes && (now - cache.lastFetch < cache.ttl) && !forceRefresh) {
                    console.log('ğŸ“¦ ä½¿ç”¨ç¼“å­˜æ•°æ®ï¼Œå…±', cache.notes.length, 'ç¯‡åšå®¢');
                    allNotes = cache.notes;
                } else {
                    console.log('ğŸ”„ é‡æ–°è·å–åšå®¢æ•°æ®...');
                    allNotes = await window.githubNoteManager.scanAllNotes();
                    cache.notes = allNotes;
                    cache.lastFetch = now;
                    console.log('âœ… è·å–åˆ°', allNotes.length, 'ç¯‡åšå®¢');
                }

                if (allNotes.length === 0) {
                    notesGrid.innerHTML =
                        '<div style="text-align: center; padding: 40px; color: var(--text-secondary);">æš‚æ— åšå®¢</div>';
                    return;
                }

                filteredNotes = [...allNotes];
                displayNotesBatch();
                loadTags();
                updateLastUpdateTime();
            } catch (error) {
                console.error('åŠ è½½åšå®¢å¤±è´¥:', error);
                notesGrid.innerHTML =
                    '<div style="text-align: center; padding: 40px; color: var(--danger);">åŠ è½½å¤±è´¥: ' + error.message + '</div>';
            }
        }

        // åˆ†æ‰¹æ˜¾ç¤ºåšå®¢
        async function displayNotesBatch() {
            const notesGrid = document.getElementById('notesGrid');
            const emptyState = document.getElementById('emptyState');
            emptyState.style.display = 'none';

            // æ’åº
            filteredNotes.sort((a, b) => {
                switch (currentSort) {
                    case 'date-desc': return new Date(b.date) - new Date(a.date);
                    case 'date-asc': return new Date(a.date) - new Date(b.date);
                    case 'title-asc': return a.title.localeCompare(b.title);
                    case 'title-desc': return b.title.localeCompare(a.title);
                    default: return 0;
                }
            });

            if (filteredNotes.length === 0) {
                emptyState.style.display = 'block';
                notesGrid.innerHTML = '';
                return;
            }

            // ç§»é™¤æ—§çš„æ»šåŠ¨ç›‘å¬å™¨ï¼Œé˜²æ­¢é‡å¤
            if (window._scrollListener) {
                window.removeEventListener('scroll', window._scrollListener);
            }

            // åˆå§‹æ˜¾ç¤ºå‰3ä¸ª
            const batchSize = 3;
            let currentIndex = 0;

            // æ¸²æŸ“ç¬¬ä¸€æ‰¹
            await renderBatch(0, Math.min(batchSize, filteredNotes.length));
            currentIndex = batchSize;

            // æ»šåŠ¨åŠ è½½æ›´å¤š
            window._scrollListener = () => {
                if (currentIndex >= filteredNotes.length) {
                    window.removeEventListener('scroll', window._scrollListener);
                    return;
                }
                renderBatch(currentIndex, Math.min(currentIndex + batchSize, filteredNotes.length));
                currentIndex += batchSize;
            };

            window.addEventListener('scroll', window._scrollListener);
        }

        // æ¸²æŸ“ä¸€æ‰¹åšå®¢
        async function renderBatch(start, end) {
            const notesGrid = document.getElementById('notesGrid');
            const batch = filteredNotes.slice(start, end);

            // å¦‚æœæ˜¯ç¬¬ä¸€æ‰¹ï¼Œæ¸…ç©ºgrid
            if (start === 0) {
                notesGrid.innerHTML = '';
            }

            // æ‰¹é‡è·å–æ‰€æœ‰è¯„è®ºæ•°ï¼ˆä»Næ¬¡APIè°ƒç”¨å‡å°‘åˆ°1æ¬¡ï¼‰
            const noteIds = batch.map(note => note.id);
            const commentCountMap = await window.githubNoteManager.getAllCommentsCount(noteIds);
            const notesWithCounts = batch.map(note => ({
                ...note,
                commentCount: commentCountMap[note.id] || 0
            }));

            for (const note of notesWithCounts) {
                const noteCard = document.createElement('div');
                noteCard.className = 'note-card';
                noteCard.style.position = 'relative';  // ä¸ºç¼–è¾‘æŒ‰é’®æä¾›å®šä½ä¸Šä¸‹æ–‡
                noteCard.onclick = (e) => {
                    // å¦‚æœç‚¹å‡»çš„æ˜¯ç¼–è¾‘æŒ‰é’®ï¼Œä¸è§¦å‘è·³è½¬
                    if (e.target.closest('.edit-btn')) {
                        return;
                    }
                    // æ‰€æœ‰åšå®¢éƒ½è·³è½¬åˆ°note.htmlï¼Œåœ¨note.htmlä¸­åŠ è½½å†…å®¹
                    location.href = `note.html?id=${note.id}`;
                };

                // æ„å»ºHTML
                let html = `
                    <div class="note-card-header">
                        <div class="note-card-icon">ğŸ“</div>
                        <div>
                            <div class="note-card-title">${escapeHtml(note.title)}</div>
                            <div class="note-card-date">${formatDate(note.date)}</div>
                        </div>
                    </div>
                    <div class="note-card-excerpt">${escapeHtml(note.excerpt || '')}</div>
                `;

                if (note.tags && note.tags.length > 0) {
                    html += `
                        <div class="note-card-tags">
                            ${note.tags.map(tag => `<span class="note-card-tag">${escapeHtml(tag)}</span>`).join('')}
                        </div>
                    `;
                }

                html += `
                    <div class="note-card-footer">
                        <div class="note-card-meta">
                            <i class="fas fa-comments"></i>
                            <span>${note.commentCount} è¯„è®º</span>
                        </div>
                `;

                // å¦‚æœæœ‰ä¿®æ”¹å¯†é’¥ï¼Œæ˜¾ç¤ºç¼–è¾‘æŒ‰é’®
                if (note.editKey) {
                    html += `
                        <button class="edit-btn" onclick="editNote('${note.id}', '${note.editKey}', event)" style="
                            position: absolute;
                            top: 12px;
                            right: 12px;
                            padding: 6px 10px;
                            background: var(--primary);
                            color: white;
                            border: none;
                            border-radius: 6px;
                            font-size: 12px;
                            cursor: pointer;
                            transition: all 0.2s;
                        ">
                            <i class="fas fa-edit"></i> ç¼–è¾‘
                        </button>
                    `;
                }

                html += `</div>`;
                noteCard.innerHTML = html;
                notesGrid.appendChild(noteCard);
            }
        }


        // ç¼“å­˜tagsæ•°æ®ï¼Œé¿å…é‡å¤è¯·æ±‚
        let cachedTags = null;

        // åŠ è½½æ ‡ç­¾ - ä»tags.jsonåŠ è½½
        async function loadTags() {
            const filterTags = document.getElementById('filterTags');

            try {
                // ç›´æ¥ä»GitHub APIè·å–tags.json
                const tagsData = await window.githubNoteManager.getFile('tags.json');
                const tags = tagsData?.tags || {};
                cachedTags = tags; // ç¼“å­˜æ•°æ®

                console.log('ğŸ·ï¸ åŠ è½½æ ‡ç­¾ï¼Œtags.json:', tags);

                const tagCountMap = new Map(Object.entries(tags));

                if (tagCountMap.size === 0) {
                    filterTags.innerHTML = '<span style="color: var(--text-secondary); font-size: 14px;">æš‚æ— æ ‡ç­¾</span>';
                    return;
                }

                // æŒ‰ä½¿ç”¨æ¬¡æ•°é™åºæ’åºï¼Œå–å‰20ä¸ª
                const sortedTags = Array.from(tagCountMap.entries())
                    .sort((a, b) => b[1] - a[1])
                    .slice(0, 20)
                    .map(([tag, count]) => ({ tag, count }));

                console.log('ğŸ” æ’åºåçš„æ ‡ç­¾:', sortedTags);

                // åˆ¤æ–­æ˜¯å¦éœ€è¦æŠ˜å ï¼ˆè¶…è¿‡9ä¸ªæ ‡ç­¾ï¼‰
                const maxVisibleTags = 9;
                const needsCollapse = sortedTags.length > maxVisibleTags;
                const visibleTags = needsCollapse ? sortedTags.slice(0, maxVisibleTags) : sortedTags;
                const collapsedTags = needsCollapse ? sortedTags.slice(maxVisibleTags) : [];

                let html = '';

                // æ˜¾ç¤ºå¯è§æ ‡ç­¾
                visibleTags.forEach(({ tag, count }) => {
                    const isActive = currentFilter === tag;
                    html += `
                        <button class="btn tag-with-count ${isActive ? 'btn-primary' : 'btn-secondary'}"
                                onclick="filterByTag('${escapeHtml(tag)}')"
                                data-count="${count}"
                                style="margin-right: 8px; margin-bottom: 8px; position: relative;">
                            ${escapeHtml(tag)}
                        </button>
                    `;
                });

                // å¦‚æœæœ‰æŠ˜å çš„æ ‡ç­¾ï¼Œæ·»åŠ å±•å¼€/æ”¶èµ·æŒ‰é’®
                if (needsCollapse && collapsedTags.length > 0) {
                    html += `
                        <button class="btn btn-secondary"
                                onclick="toggleTagCollapse()"
                                id="tagCollapseBtn"
                                style="margin-right: 8px; margin-bottom: 8px;">
                            <i class="fas fa-chevron-down"></i> æ›´å¤š (${collapsedTags.length})
                        </button>
                    `;
                }

                filterTags.innerHTML = html;
            } catch (error) {
                console.error('åŠ è½½æ ‡ç­¾å¤±è´¥:', error);
                filterTags.innerHTML = '<span style="color: var(--danger); font-size: 14px;">åŠ è½½æ ‡ç­¾å¤±è´¥</span>';
            }
        }

        // åˆ‡æ¢æ ‡ç­¾æŠ˜å çŠ¶æ€ - ä½¿ç”¨ç¼“å­˜çš„tags
        function toggleTagCollapse() {
            const collapseBtn = document.getElementById('tagCollapseBtn');
            const collapsedDiv = document.getElementById('collapsedTags');

            // å¦‚æœå·²ç»å±•å¼€ï¼Œåˆ™æ”¶èµ·ï¼ˆç§»é™¤æŠ˜å çš„æ ‡ç­¾ï¼‰
            if (collapsedDiv) {
                collapsedDiv.remove();
                // ä½¿ç”¨ç¼“å­˜çš„tagsè®¡ç®—æ•°é‡
                if (cachedTags) {
                    const sortedTags = Object.entries(cachedTags)
                        .sort((a, b) => b[1] - a[1])
                        .slice(0, 20);
                    const count = Math.max(0, sortedTags.length - 9);
                    collapseBtn.innerHTML = `<i class="fas fa-chevron-down"></i> æ›´å¤š (${count})`;
                }
            } else {
                // å¦‚æœæ²¡æœ‰å±•å¼€ï¼Œåˆ™å±•å¼€ï¼ˆåˆ›å»ºå¹¶æ˜¾ç¤ºæŠ˜å çš„æ ‡ç­¾ï¼‰
                if (cachedTags) {
                    const sortedTags = Object.entries(cachedTags)
                        .sort((a, b) => b[1] - a[1])
                        .slice(0, 20)
                        .map(([tag, count]) => ({ tag, count }));

                    const maxVisibleTags = 9;
                    const collapsedTags = sortedTags.slice(maxVisibleTags);

                    const collapsedTagsHtml = collapsedTags.map(({ tag, count }) => {
                        const isActive = currentFilter === tag;
                        return `
                            <button class="btn tag-with-count ${isActive ? 'btn-primary' : 'btn-secondary'}"
                                    onclick="filterByTag('${escapeHtml(tag)}')"
                                    data-count="${count}"
                                    style="margin-right: 8px; margin-bottom: 8px; position: relative;">
                                ${escapeHtml(tag)}
                            </button>
                        `;
                    }).join('');

                    // åˆ›å»ºæ–°çš„å®¹å™¨åœ¨æŒ‰é’®åé¢
                    const newDiv = document.createElement('div');
                    newDiv.id = 'collapsedTags';
                    newDiv.style.display = 'block';
                    newDiv.style.width = '100%';
                    newDiv.innerHTML = collapsedTagsHtml;

                    // å°†æŠ˜å æ ‡ç­¾æ’å…¥åˆ°æŒ‰é’®åé¢ï¼Œç¡®ä¿å®ƒåœ¨æŒ‰é’®ä¸‹æ–¹
                    collapseBtn.parentNode.insertBefore(newDiv, collapseBtn.nextSibling);
                    collapseBtn.innerHTML = '<i class="fas fa-chevron-up"></i> æ”¶èµ·';
                }
            }
        }

        // æŒ‰æ ‡ç­¾ç­›é€‰
        function filterByTag(tag) {
            currentFilter = tag;
            applyFilters();
            loadTags();
        }

        // æ¸…é™¤ç­›é€‰
        function clearFilters() {
            currentFilter = null;
            currentSearch = '';
            document.getElementById('searchInput').value = '';
            applyFilters();
            loadTags();
        }

        // æœç´¢ - ä¼˜åŒ–æ€§èƒ½ï¼Œä½¿ç”¨é˜²æŠ–
        let searchTimer = null;
        document.getElementById('searchInput').addEventListener('input', function(e) {
            clearTimeout(searchTimer);
            searchTimer = setTimeout(() => {
                currentSearch = e.target.value.toLowerCase();
                applyFilters();
            }, 300); // 300ms é˜²æŠ–
        });

        // åº”ç”¨ç­›é€‰å’Œæœç´¢
        function applyFilters() {
            filteredNotes = allNotes.filter(note => {
                // æ ‡ç­¾ç­›é€‰
                if (currentFilter && (!note.tags || !note.tags.includes(currentFilter))) {
                    return false;
                }
                // æœç´¢ç­›é€‰
                if (currentSearch) {
                    const searchFields = [
                        note.title,
                        note.excerpt,
                        ...(note.tags || [])
                    ].join(' ').toLowerCase();
                    return searchFields.includes(currentSearch);
                }
                return true;
            });
            displayNotesBatch();
        }

        // æ’åº
        document.getElementById('sortBtn').addEventListener('click', function() {
            const sorts = [
                { value: 'date-desc', label: 'æœ€æ–°å‘å¸ƒ' },
                { value: 'date-asc', label: 'æœ€æ—§å‘å¸ƒ' },
                { value: 'title-asc', label: 'æ ‡é¢˜ A-Z' },
                { value: 'title-desc', label: 'æ ‡é¢˜ Z-A' }
            ];
            const currentIndex = sorts.findIndex(s => s.value === currentSort);
            const nextIndex = (currentIndex + 1) % sorts.length;
            currentSort = sorts[nextIndex].value;
            displayNotesBatch();
        });

        // åˆ·æ–°ï¼ˆæ¸…é™¤ç¼“å­˜ï¼‰
        document.getElementById('refreshBtn').addEventListener('click', async function() {
            const originalText = this.innerHTML;
            const originalClass = this.className;

            try {
                // æ›´æ–°æŒ‰é’®çŠ¶æ€
                this.innerHTML = '<i class="fas fa-spinner fa-spin"></i> åˆ·æ–°ä¸­...';
                this.classList.add('spinning');

                // æ¸…é™¤æ‰€æœ‰ç¼“å­˜ - åŒ…æ‹¬å†…å­˜ç¼“å­˜ã€localStorageå’Œæµè§ˆå™¨ç¼“å­˜
                cache.notes = null;
                cache.lastFetch = 0;
                localStorage.removeItem('notesCacheInvalidate');
                localStorage.setItem('notesCacheInvalidate', Date.now().toString()); // è§¦å‘å¼ºåˆ¶åˆ·æ–°

                // æ¸…é™¤æµè§ˆå™¨fetchç¼“å­˜
                if ('caches' in window) {
                    caches.keys().then(names => {
                        names.forEach(name => caches.delete(name));
                    });
                }

                console.log('ğŸ”„ æ‰‹åŠ¨åˆ·æ–°ç¼“å­˜ï¼Œé‡æ–°åŠ è½½æ•°æ®...');

                // é‡æ–°åŠ è½½æ•°æ®
                await loadNotes();

                // æ˜¾ç¤ºæˆåŠŸæç¤º
                this.innerHTML = '<i class="fas fa-check"></i> å·²åˆ·æ–°';
                this.style.background = 'var(--success)';

                setTimeout(() => {
                    this.innerHTML = originalText;
                    this.style.background = '';
                    this.className = originalClass;
                }, 1500);

            } catch (error) {
                console.error('åˆ·æ–°å¤±è´¥:', error);
                this.innerHTML = '<i class="fas fa-times"></i> åˆ·æ–°å¤±è´¥';
                this.style.background = 'var(--danger)';

                setTimeout(() => {
                    this.innerHTML = originalText;
                    this.style.background = '';
                    this.className = originalClass;
                }, 2000);
            }
        });

        // å·¥å…·å‡½æ•°
        function formatDate(dateStr) {
            const date = new Date(dateStr);
            return date.toLocaleDateString('zh-CN', { year: 'numeric', month: 'long', day: 'numeric' });
        }

        // ç¼–è¾‘åšå®¢
        window.editNote = function(noteId, editKey, event) {
            event.stopPropagation(); // é˜»æ­¢äº‹ä»¶å†’æ³¡
            const inputKey = prompt('è¯·è¾“å…¥ä¿®æ”¹å¯†é’¥:');
            if (inputKey === null) return;  // ç”¨æˆ·å–æ¶ˆ

            if (inputKey !== editKey) {
                alert('ä¿®æ”¹å¯†é’¥é”™è¯¯ï¼');
                return;
            }

            // è·³è½¬åˆ°ç¼–è¾‘é¡µé¢
            window.location.href = `write.html?edit=${noteId}`;
        };

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function updateLastUpdateTime() {
            const lastUpdate = document.getElementById('lastUpdate');
            if (lastUpdate) {
                const now = new Date();
                lastUpdate.textContent = 'æœ€åæ›´æ–°: ' + now.toLocaleTimeString('zh-CN');
            }
        }
    </script>

    <style>
        /* æ ‡ç­¾è®¡æ•°æ‚¬åœæ˜¾ç¤º */
        .tag-with-count {
            position: relative;
        }

        .tag-with-count::after {
            content: attr(data-count);
            position: absolute;
            top: -2px;
            right: -2px;
            background: var(--bg-tertiary);
            color: var(--text-secondary);
            border-radius: 10px;
            padding: 2px 6px;
            font-size: 10px;
            font-weight: 500;
            opacity: 0;
            transition: opacity 0.2s ease;
            pointer-events: none;
        }

        .tag-with-count:hover::after {
            opacity: 1;
        }
    </style>
</body>

</html>
