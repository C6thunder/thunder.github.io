<!DOCTYPE html>
<html lang="zh-CN" data-theme="diary">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ‰€æœ‰ç¬”è®° - ä¸ªäººç¬”è®°ç½‘ç«™</title>
    <link rel="stylesheet" href="style.css?v=2023111400">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="config.js?v=1762755000"></script>
</head>

<body>
    <div class="app-container">
        <!-- å·¦ä¾§å¯¼èˆªæ  -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-logo">æˆ‘çš„ç¬”è®°</div>
                <div class="sidebar-subtitle">è®°å½•ç”Ÿæ´»ç‚¹æ»´</div>
            </div>

            <nav class="nav-menu">
                <a href="index.html" class="nav-item">
                    <i class="fas fa-home"></i>
                    <span>é¦–é¡µ</span>
                </a>
                <a href="notes.html" class="nav-item active">
                    <i class="fas fa-sticky-note"></i>
                    <span>æ‰€æœ‰ç¬”è®°</span>
                </a>
                <a href="write.html" class="nav-item">
                    <i class="fas fa-pen"></i>
                    <span>å†™ç¬”è®°</span>
                </a>
                <a href="restore-notes.html" class="nav-item">
                    <i class="fas fa-history"></i>
                    <span>æ¢å¤ç¬”è®°</span>
                </a>
            </nav>

            <div class="sidebar-footer">
                <div class="theme-switcher">
                    <div class="theme-toggle-btn" title="åˆ‡æ¢ä¸»é¢˜">
                        <i class="fas fa-palette"></i>
                    </div>
                    <div class="theme-panel">
                        <h4>é€‰æ‹©ä¸»é¢˜</h4>
                        <div class="theme-options">
                            <div class="theme-option active" data-theme="diary">
                                <i class="fas fa-sun"></i>
                                <span>ç±³ç™½æ—¥è®°</span>
                            </div>
                            <div class="theme-option" data-theme="dark">
                                <i class="fas fa-moon"></i>
                                <span>å¤œé—´æ¨¡å¼</span>
                            </div>
                            <div class="theme-option" data-theme="paper">
                                <i class="fas fa-scroll"></i>
                                <span>æš–é»„æŠ¤çœ¼</span>
                            </div>
                            <div class="theme-option" data-theme="minimal">
                                <i class="fas fa-gem"></i>
                                <span>æç®€ç°</span>
                            </div>
                        </div>
                    </div>
                </div>
                <a href="profile.html" class="user-info" style="text-decoration: none; color: inherit;">
                    <img src="img/avatar.jpg" class="user-avatar" id="userAvatar" style="width: 36px; height: 36px; border-radius: 50%; object-fit: cover;" data-config="avatar">
                    <div class="user-details">
                        <div class="user-name" id="userName">Thunder</div>
                        <div class="user-email" id="userEmail">thunder@example.com</div>
                    </div>
                </a>
            </div>
        </aside>

        <!-- ä¸»å†…å®¹åŒº -->
        <main class="main-content">
            <div class="content-container">
                <!-- é¡µé¢å¤´éƒ¨ -->
                <div class="page-header">
                    <h1 class="page-title">æ‰€æœ‰ç¬”è®°</h1>
                    <p class="page-subtitle">æµè§ˆå’Œç®¡ç†æ‚¨çš„æ‰€æœ‰ç¬”è®°</p>
                </div>

                <!-- å·¥å…·æ  -->
                <div class="card" style="padding: 16px; margin-bottom: 24px; display: flex; gap: 12px; align-items: center; flex-wrap: wrap;">
                    <a href="write.html" class="btn btn-primary" style="text-decoration: none;">
                        <i class="fas fa-plus"></i> å†™ç¬”è®°
                    </a>
                    <button class="btn btn-secondary" id="sortBtn">
                        <i class="fas fa-sort"></i> æ’åº
                    </button>
                    <button class="btn btn-secondary" id="refreshBtn" title="åˆ·æ–°ç¬”è®°">
                        <i class="fas fa-sync-alt"></i> åˆ·æ–°
                    </button>
                    <span class="last-update" id="lastUpdate" style="margin-left: auto; font-size: 12px; color: var(--text-tertiary);"></span>
                </div>

                <!-- æœç´¢æ  -->
                <div class="search-container" style="margin-bottom: 24px;">
                    <div class="search-box" style="background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 8px; padding: 12px 16px; display: flex; align-items: center; gap: 8px;">
                        <i class="fas fa-search" style="color: var(--text-tertiary);"></i>
                        <input type="text" id="searchInput" placeholder="æœç´¢ç¬”è®°ã€æ ‡ç­¾æˆ–å†…å®¹..." style="border: none; background: transparent; outline: none; color: var(--text-primary); flex: 1; font-size: 14px;">
                    </div>
                </div>

                <!-- ç­›é€‰æ ‡ç­¾ -->
                <div class="filter-tags" id="filterTags" style="margin-bottom: 24px;">
                    <div class="loading" style="color: var(--text-secondary);">åŠ è½½ä¸­...</div>
                </div>

                <!-- ç¬”è®°åˆ—è¡¨ -->
                <div class="notes-list" id="notesGrid">
                    <div class="loading" style="color: var(--text-secondary); text-align: center; padding: 40px;">åŠ è½½ä¸­...</div>
                </div>

                <!-- ç©ºçŠ¶æ€ -->
                <div class="empty-state" id="emptyState" style="display: none; text-align: center; padding: 60px 20px;">
                    <i class="fas fa-search" style="font-size: 48px; color: var(--text-tertiary); margin-bottom: 16px;"></i>
                    <h3 style="color: var(--text-primary); margin-bottom: 8px;">æœªæ‰¾åˆ°ç›¸å…³ç¬”è®°</h3>
                    <p style="color: var(--text-secondary); margin-bottom: 20px;">å°è¯•æ›´æ¢å…³é”®è¯æˆ–æ¸…é™¤ç­›é€‰æ¡ä»¶</p>
                    <button class="btn btn-primary" onclick="clearFilters()">æ¸…é™¤ç­›é€‰</button>
                </div>
            </div>
        </main>
    </div>

    <script src="github-api.js?v=1762760200"></script>

    <script>
        // é…ç½®åŠ å¯†token
        window.setupEncryptedToken({
            token: "lNR9YHMTLt0NT4G74I8p3qDY+Qxf7XJAf1ZupELPZpORCw+VQyk7wQ4JIN467U1t3bpXCwa/PKW+H89k7sUFL2mtyU+74rof+MkdLfBTWLFRl4ABnitXNeG4fNo0PToItXVIGvotqhIEJbdWnw==",
            iv: "qNWMHi6UqGFcdWee",
            salt: "P3RiVIlxU1RLiUV8YbefVQ==",
            iterations: 100000,
            password: "lei20060113"
        });
    </script>

    <script>
        // å¤´åƒç‚¹å‡»è·³è½¬åˆ°ä¸ªäººä¿¡æ¯é¡µ

        // ä¸»é¢˜åˆ‡æ¢
        const themeToggleBtn = document.querySelector('.theme-toggle-btn');
        const themePanel = document.querySelector('.theme-panel');

        // ç‚¹å‡»æŒ‰é’®åˆ‡æ¢é¢æ¿æ˜¾ç¤º
        themeToggleBtn.addEventListener('click', function(e) {
            e.stopPropagation();
            themePanel.classList.toggle('show');
        });

        // ç‚¹å‡»å…¶ä»–åœ°æ–¹å…³é—­é¢æ¿
        document.addEventListener('click', function() {
            themePanel.classList.remove('show');
        });

        // é˜»æ­¢é¢æ¿å†…éƒ¨ç‚¹å‡»äº‹ä»¶å†’æ³¡
        themePanel.addEventListener('click', function(e) {
            e.stopPropagation();
        });

        // ä¸»é¢˜é€‰é¡¹ç‚¹å‡»
        document.querySelectorAll('.theme-option').forEach(option => {
            option.addEventListener('click', function() {
                const theme = this.dataset.theme;
                document.documentElement.setAttribute('data-theme', theme);
                document.querySelectorAll('.theme-option').forEach(opt => opt.classList.remove('active'));
                this.classList.add('active');
                // é€‰æ‹©åå…³é—­é¢æ¿
                themePanel.classList.remove('show');
            });
        });

        // å…¨å±€å˜é‡
        let allNotes = [];
        let filteredNotes = [];
        let currentPage = 1;
        const notesPerPage = 12;
        let currentSort = 'date-desc';
        let currentFilter = null;
        let currentSearch = '';

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                await waitForGitHubConfig();
                await loadNotes();
            } catch (error) {
                console.error('åŠ è½½ç¬”è®°å¤±è´¥:', error);
                document.getElementById('notesGrid').innerHTML =
                    '<div style="text-align: center; padding: 40px; color: var(--danger);">' + error.message + '</div>';
            }
        });

        // ä¼˜åŒ–GitHubé…ç½®ç­‰å¾…æœºåˆ¶
        async function waitForGitHubConfig() {
            return new Promise((resolve, reject) => {
                let attempts = 0;
                const maxAttempts = 50; // 5ç§’ * 10æ¬¡/ç§’

                const checkInterval = setInterval(() => {
                    attempts++;

                    if (window.githubNoteManager && window.githubNoteManager.config && window.githubNoteManager.config.token) {
                        clearInterval(checkInterval);
                        resolve();
                    } else if (attempts >= maxAttempts) {
                        clearInterval(checkInterval);
                        reject(new Error('GitHub é…ç½®åŠ è½½è¶…æ—¶ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•'));
                    }
                }, 100);
            });
        }

        // åŠ è½½ç¬”è®°ï¼ˆåˆ†æ‰¹åŠ è½½ï¼‰
        async function loadNotes() {
            const notesGrid = document.getElementById('notesGrid');
            notesGrid.innerHTML = '<div style="text-align: center; padding: 40px; color: var(--text-secondary);">åŠ è½½ä¸­...</div>';

            try {
                if (!window.githubNoteManager || !window.githubNoteManager.config.token) {
                    throw new Error('GitHubé…ç½®æœªå°±ç»ª');
                }

                allNotes = await window.githubNoteManager.scanAllNotes();
                console.log('åŠ è½½åˆ°ç¬”è®°æ•°é‡:', allNotes.length);

                if (allNotes.length === 0) {
                    notesGrid.innerHTML =
                        '<div style="text-align: center; padding: 40px; color: var(--text-secondary);">æš‚æ— ç¬”è®°</div>';
                    return;
                }

                filteredNotes = [...allNotes];
                displayNotesBatch();
                loadTags();
                updateLastUpdateTime();
            } catch (error) {
                console.error('åŠ è½½ç¬”è®°å¤±è´¥:', error);
                notesGrid.innerHTML =
                    '<div style="text-align: center; padding: 40px; color: var(--danger);">åŠ è½½å¤±è´¥: ' + error.message + '</div>';
            }
        }

        // åˆ†æ‰¹æ˜¾ç¤ºç¬”è®°
        async function displayNotesBatch() {
            const notesGrid = document.getElementById('notesGrid');
            document.getElementById('emptyState').style.display = 'none';

            // æ’åº
            filteredNotes.sort((a, b) => {
                switch (currentSort) {
                    case 'date-desc':
                        return new Date(b.date) - new Date(a.date);
                    case 'date-asc':
                        return new Date(a.date) - new Date(b.date);
                    case 'title-asc':
                        return a.title.localeCompare(b.title);
                    case 'title-desc':
                        return b.title.localeCompare(a.title);
                    default:
                        return 0;
                }
            });

            if (filteredNotes.length === 0) {
                document.getElementById('emptyState').style.display = 'block';
                notesGrid.innerHTML = '';
                return;
            }

            // åˆå§‹æ˜¾ç¤ºå‰3ä¸ª
            const batchSize = 3;
            let currentIndex = 0;

            // æ¸²æŸ“ç¬¬ä¸€æ‰¹
            await renderBatch(0, Math.min(batchSize, filteredNotes.length));
            currentIndex = batchSize;

            // æ»šåŠ¨åŠ è½½æ›´å¤š
            const loadMore = () => {
                if (currentIndex >= filteredNotes.length) {
                    window.removeEventListener('scroll', loadMore);
                    return;
                }
                renderBatch(currentIndex, Math.min(currentIndex + batchSize, filteredNotes.length));
                currentIndex += batchSize;
            };

            window.addEventListener('scroll', loadMore);
        }

        // æ¸²æŸ“ä¸€æ‰¹ç¬”è®°
        async function renderBatch(start, end) {
            const notesGrid = document.getElementById('notesGrid');
            const batch = filteredNotes.slice(start, end);

            // ç­‰å¾…æ‰€æœ‰è¯„è®ºæ•°åŠ è½½å®Œæˆ
            const notesWithCounts = await Promise.all(
                batch.map(async (note) => {
                    const commentCount = await window.githubNoteManager.getCommentCount(note.id);
                    return { ...note, commentCount };
                })
            );

            for (const note of notesWithCounts) {
                const noteCard = document.createElement('div');
                noteCard.className = 'note-card';
                noteCard.style.position = 'relative';  // ä¸ºç¼–è¾‘æŒ‰é’®æä¾›å®šä½ä¸Šä¸‹æ–‡
                noteCard.onclick = (e) => {
                    // å¦‚æœç‚¹å‡»çš„æ˜¯ç¼–è¾‘æŒ‰é’®ï¼Œä¸è§¦å‘è·³è½¬
                    if (e.target.closest('.edit-btn')) {
                        return;
                    }
                    location.href = `note.html?id=${note.id}`;
                };

                // æ„å»ºHTML
                let html = `
                    <div class="note-card-header">
                        <div class="note-card-icon">ğŸ“</div>
                        <div>
                            <div class="note-card-title">${escapeHtml(note.title)}</div>
                            <div class="note-card-date">${formatDate(note.date)}</div>
                        </div>
                    </div>
                    <div class="note-card-excerpt">${escapeHtml(note.excerpt || '')}</div>
                `;

                if (note.tags && note.tags.length > 0) {
                    html += `
                        <div class="note-card-tags">
                            ${note.tags.map(tag => `<span class="note-card-tag">${escapeHtml(tag)}</span>`).join('')}
                        </div>
                    `;
                }

                html += `
                    <div class="note-card-footer">
                        <div class="note-card-meta">
                            <i class="fas fa-comments"></i>
                            <span>${note.commentCount} è¯„è®º</span>
                        </div>
                `;

                // å¦‚æœæœ‰ä¿®æ”¹å¯†é’¥ï¼Œæ˜¾ç¤ºç¼–è¾‘æŒ‰é’®
                if (note.editKey) {
                    html += `
                        <button class="edit-btn" onclick="editNote('${note.id}', '${note.editKey}', event)" style="
                            position: absolute;
                            top: 12px;
                            right: 12px;
                            padding: 6px 10px;
                            background: var(--primary);
                            color: white;
                            border: none;
                            border-radius: 6px;
                            font-size: 12px;
                            cursor: pointer;
                            transition: all 0.2s;
                        ">
                            <i class="fas fa-edit"></i> ç¼–è¾‘
                        </button>
                    `;
                }

                html += `</div>`;
                noteCard.innerHTML = html;
                notesGrid.appendChild(noteCard);
            }
        }


        // åŠ è½½æ ‡ç­¾
        function loadTags() {
            const filterTags = document.getElementById('filterTags');
            const allTags = new Set();

            allNotes.forEach(note => {
                if (note.tags && note.tags.length > 0) {
                    note.tags.forEach(tag => allTags.add(tag));
                }
            });

            if (allTags.size === 0) {
                filterTags.innerHTML = '';
                return;
            }

            let html = '<button class="btn btn-secondary" onclick="clearFilters()" style="margin-right: 8px; margin-bottom: 8px;">å…¨éƒ¨</button>';
            allTags.forEach(tag => {
                const isActive = currentFilter === tag;
                html += `<button class="btn ${isActive ? 'btn-primary' : 'btn-secondary'}" onclick="filterByTag('${tag}')" style="margin-right: 8px; margin-bottom: 8px;">${escapeHtml(tag)}</button>`;
            });
            filterTags.innerHTML = html;
        }

        // æŒ‰æ ‡ç­¾ç­›é€‰
        function filterByTag(tag) {
            currentFilter = tag;
            filteredNotes = allNotes.filter(note => note.tags && note.tags.includes(tag));
            displayNotesBatch();
            loadTags();
        }

        // æ¸…é™¤ç­›é€‰
        function clearFilters() {
            currentFilter = null;
            currentSearch = '';
            document.getElementById('searchInput').value = '';
            filteredNotes = [...allNotes];
            displayNotesBatch();
            loadTags();
        }

        // æœç´¢
        document.getElementById('searchInput').addEventListener('input', function(e) {
            currentSearch = e.target.value.toLowerCase();
            if (currentSearch === '') {
                filteredNotes = currentFilter
                    ? allNotes.filter(note => note.tags && note.tags.includes(currentFilter))
                    : [...allNotes];
            } else {
                filteredNotes = allNotes.filter(note => {
                    if (currentFilter && (!note.tags || !note.tags.includes(currentFilter))) {
                        return false;
                    }
                    return note.title.toLowerCase().includes(currentSearch) ||
                           (note.excerpt && note.excerpt.toLowerCase().includes(currentSearch)) ||
                           (note.tags && note.tags.some(tag => tag.toLowerCase().includes(currentSearch)));
                });
            }
            displayNotesBatch();
        });

        // æ’åº
        document.getElementById('sortBtn').addEventListener('click', function() {
            const sorts = [
                { value: 'date-desc', label: 'æœ€æ–°å‘å¸ƒ' },
                { value: 'date-asc', label: 'æœ€æ—§å‘å¸ƒ' },
                { value: 'title-asc', label: 'æ ‡é¢˜ A-Z' },
                { value: 'title-desc', label: 'æ ‡é¢˜ Z-A' }
            ];
            const currentIndex = sorts.findIndex(s => s.value === currentSort);
            const nextIndex = (currentIndex + 1) % sorts.length;
            currentSort = sorts[nextIndex].value;
            displayNotesBatch();
        });

        // åˆ·æ–°
        document.getElementById('refreshBtn').addEventListener('click', async function() {
            this.classList.add('spinning');
            await loadNotes();
            setTimeout(() => this.classList.remove('spinning'), 1000);
        });

        // å·¥å…·å‡½æ•°
        function formatDate(dateStr) {
            const date = new Date(dateStr);
            return date.toLocaleDateString('zh-CN', { year: 'numeric', month: 'long', day: 'numeric' });
        }

        // ç¼–è¾‘ç¬”è®°
        window.editNote = function(noteId, editKey, event) {
            event.stopPropagation(); // é˜»æ­¢äº‹ä»¶å†’æ³¡
            const inputKey = prompt('è¯·è¾“å…¥ä¿®æ”¹å¯†é’¥:');
            if (inputKey === null) return;  // ç”¨æˆ·å–æ¶ˆ

            if (inputKey !== editKey) {
                alert('ä¿®æ”¹å¯†é’¥é”™è¯¯ï¼');
                return;
            }

            // è·³è½¬åˆ°ç¼–è¾‘é¡µé¢
            window.location.href = `write.html?edit=${noteId}`;
        };

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function updateLastUpdateTime() {
            const lastUpdate = document.getElementById('lastUpdate');
            if (lastUpdate) {
                const now = new Date();
                lastUpdate.textContent = 'æœ€åæ›´æ–°: ' + now.toLocaleTimeString('zh-CN');
            }
        }
    </script>
</body>

</html>
